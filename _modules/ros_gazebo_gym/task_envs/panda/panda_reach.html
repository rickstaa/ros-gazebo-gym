<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ros_gazebo_gym.task_envs.panda.panda_reach &mdash; ROS Gazebo Gym 2.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=eafc0fe6" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/modify.css?v=519ed47b" />

  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=d7b522e2"></script>
        <script src="../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html">
            
              <img src="../../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/usage.html">How to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/envs.html">Environments</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev/contributing.html">Contribute to ros-gazebo-gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev/add_nev_env.html">Add new environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev/doc_dev.html">Release documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev/openai_ros_diff.html">Difference with openai_ros</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../autoapi/index.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../etc/acknowledgements.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ROS Gazebo Gym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../ros_gazebo_gym.html">ros_gazebo_gym</a></li>
      <li class="breadcrumb-item active">ros_gazebo_gym.task_envs.panda.panda_reach</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ros_gazebo_gym.task_envs.panda.panda_reach</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;An ROS Panda reach gymnasium environment.</span>

<span class="sd">.. image:: /images/panda/panda_reach_env.png</span>
<span class="sd">   :alt: Panda reach environment</span>

<span class="sd">Observation space:</span>
<span class="sd">    As the panda environment inherits from the `gym.GoalEnv`_ class, the observation</span>
<span class="sd">    space is a dictionary.</span>

<span class="sd">    Type: Dict</span>
<span class="sd">        - **observation** (:obj:`numpy.ndarray`): The current end-effector pose, joint</span>
<span class="sd">          positions and joint velocities.</span>
<span class="sd">        - **desired_goal** (:obj:`numpy.ndarray`): The desired end-effector pose.</span>
<span class="sd">        - **achieved_goal** (:obj:`numpy.ndarray`): The achieved end-effector pose.</span>

<span class="sd">.. _`gym.GoalEnv`: https://robotics.farama.org/content/multi-goal_api/#goalenv</span>

<span class="sd">Action space:</span>
<span class="sd">    The action space of the panda environment is dependent on the control type and</span>
<span class="sd">    whether the gripper is loaded. The following action spaces are available:</span>

<span class="sd">    **Joint trajectory control**:</span>
<span class="sd">        Type: Box(7)</span>
<span class="sd">            - **panda_joint1** (:obj:`float`): The position of the first joint.</span>
<span class="sd">            - **panda_joint2** (:obj:`float`): The position of the second joint.</span>
<span class="sd">            - **panda_joint3** (:obj:`float`): The position of the third joint.</span>
<span class="sd">            - **panda_joint4** (:obj:`float`): The position of the fourth joint.</span>
<span class="sd">            - **panda_joint5** (:obj:`float`): The position of the fifth joint.</span>
<span class="sd">            - **panda_joint6** (:obj:`float`): The position of the sixth joint.</span>
<span class="sd">            - **panda_joint7** (:obj:`float`): The position of the seventh joint.</span>

<span class="sd">    **Joint position control**:</span>
<span class="sd">        Type: Box(7)</span>
<span class="sd">            - **panda_joint1** (:obj:`float`): The position of the first joint.</span>
<span class="sd">            - **panda_joint2** (:obj:`float`): The position of the second joint.</span>
<span class="sd">            - **panda_joint3** (:obj:`float`): The position of the third joint.</span>
<span class="sd">            - **panda_joint4** (:obj:`float`): The position of the fourth joint.</span>
<span class="sd">            - **panda_joint5** (:obj:`float`): The position of the fifth joint.</span>
<span class="sd">            - **panda_joint6** (:obj:`float`): The position of the sixth joint.</span>
<span class="sd">            - **panda_joint7** (:obj:`float`): The position of the seventh joint.</span>

<span class="sd">    **Joint effort control**:</span>
<span class="sd">        Type: Box(7)</span>
<span class="sd">            - **panda_joint1** (:obj:`float`): The effort of the first joint.</span>
<span class="sd">            - **panda_joint2** (:obj:`float`): The effort of the second joint.</span>
<span class="sd">            - **panda_joint3** (:obj:`float`): The effort of the third joint.</span>
<span class="sd">            - **panda_joint4** (:obj:`float`): The effort of the fourth joint.</span>
<span class="sd">            - **panda_joint5** (:obj:`float`): The effort of the fifth joint.</span>
<span class="sd">            - **panda_joint6** (:obj:`float`): The effort of the sixth joint.</span>
<span class="sd">            - **panda_joint7** (:obj:`float`): The effort of the seventh joint.</span>

<span class="sd">    **End-effector position control**:</span>
<span class="sd">        Type: Box(7)</span>
<span class="sd">            - **x** (:obj:`float`): The x position of the end-effector.</span>
<span class="sd">            - **y** (:obj:`float`): The y position of the end-effector.</span>
<span class="sd">            - **z** (:obj:`float`): The z position of the end-effector.</span>
<span class="sd">            - **rx** (:obj:`float`): The x component of the quaternion orientation of the</span>
<span class="sd">              end-effector.</span>
<span class="sd">            - **ry** (:obj:`float`): The y component of the quaternion orientation of the</span>
<span class="sd">              end-effector.</span>
<span class="sd">            - **rz** (:obj:`float`): The z component of the quaternion orientation of the</span>
<span class="sd">              end-effector.</span>
<span class="sd">            - **rw** (:obj:`float`): The w component of the quaternion orientation of the</span>
<span class="sd">              end-effector.</span>

<span class="sd">    If the gripper is loaded, the action space is extended with the following</span>
<span class="sd">    dimensions:</span>

<span class="sd">    Type: Box(2)</span>
<span class="sd">        - **gripper_width** (:obj:`float`): The width of the gripper - only if the</span>
<span class="sd">          gripper is loaded.</span>
<span class="sd">        - **gripper_max_effort** (:obj:`float`): The maximum effort of the gripper -</span>
<span class="sd">          only if the gripper is loaded.</span>

<span class="sd">        .. attention::</span>
<span class="sd">            The gripper width is ignored when the ``grasping`` parameter is set to ``true`` in the</span>
<span class="sd">            :ros-gazebo-gym:`task environment config file &lt;blob/noetic/src/ros_gazebo_gym/task_envs/panda/config/panda_reach.yaml&gt;`.</span>
<span class="sd">            or when the ``gripper_max_effort`` is set to a value greater than zero.</span>

<span class="sd">Episode termination:</span>
<span class="sd">    The episode terminates when the end-effector is within a certain distance of the</span>
<span class="sd">    goal position. The distance is defined by the ``distance_threshold`` parameter in</span>
<span class="sd">    the task environment configuration file. If the ``hold_samples`` parameter is</span>
<span class="sd">    greater than zero, the episode will terminate after ``hold_samples`` consecutive</span>
<span class="sd">    samples are within the ``distance_threshold``. The episode will also terminate if</span>
<span class="sd">    the maximum number of samples is reached.</span>

<span class="sd">Environment Goal:</span>
<span class="sd">    In this environment the agent has to learn to move the panda robot to a given goal</span>
<span class="sd">    position. It was based on the :gymnasium-robotics:`FetchReach-v2 &lt;envs/fetch/reach/&gt;`</span>
<span class="sd">    gymnasium environment.</span>

<span class="sd">Reward function:</span>
<span class="sd">    The reward function is defined as the negative of the Euclidean distance between the</span>
<span class="sd">    end-effector and the goal position. If the ``positive_reward`` parameter is set to</span>
<span class="sd">    ``true``, the absolute value of the reward is returned:</span>

<span class="sd">    .. math::</span>
<span class="sd">        reward = -\sqrt{(x_{ee} - x_{goal})^2 + (y_{ee} - y_{goal})^2 + (z_{ee} - z_{goal})^2}</span>

<span class="sd">Initialization:</span>
<span class="sd">    The environment is initialized by loading the Panda robot model and setting its</span>
<span class="sd">    initial position and orientation. The environment parameters can be set in the</span>
<span class="sd">    configuration file located at `ros_gazebo_gym/task_envs/panda/config/panda_reach.yaml`.</span>

<span class="sd">Environment step return:</span>

<span class="sd">    In addition to the observations, the reward, and a termination and truncation boolean,</span>
<span class="sd">    the environment also returns an info dictionary:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        [observation, reward, termination, truncation, info_dict]</span>

<span class="sd">    The info dictionary contains the following information:</span>

<span class="sd">    - **reference**: The reference position (x,y,z) that the Panda Reach is tracking (i.e. the goal position).</span>
<span class="sd">    - **state_of_interest**: The state that should track the reference (SOI) (i.e. the end-effector position).</span>
<span class="sd">    - **reference_error**: The error between SOI and the reference (i.e. the error between the end-effector position and the goal position).</span>

<span class="sd">.. admonition:: Configuration</span>
<span class="sd">    :class: important</span>

<span class="sd">    The configuration files for this environment are found in the</span>
<span class="sd">    :ros-gazebo-gym:`panda task environment config folder &lt;blob/noetic/src/ros_gazebo_gym/task_envs/panda/config/panda_reach.yaml&gt;`.</span>
<span class="sd">&quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">Quaternion</span>
<span class="kn">from</span> <span class="nn">gymnasium</span> <span class="kn">import</span> <span class="n">spaces</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.common.helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">flatten_list</span><span class="p">,</span>
    <span class="n">gripper_width_2_finger_joints_positions</span><span class="p">,</span>
    <span class="n">list_2_human_text</span><span class="p">,</span>
    <span class="n">pose_msg_2_pose_dict</span><span class="p">,</span>
    <span class="n">shallow_dict_merge</span><span class="p">,</span>
    <span class="n">split_bounds_dict</span><span class="p">,</span>
    <span class="n">split_pose_dict</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.common.markers.sample_region_marker</span> <span class="kn">import</span> <span class="n">SampleRegionMarker</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.common.markers.target_marker</span> <span class="kn">import</span> <span class="n">TargetMarker</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.core</span> <span class="kn">import</span> <span class="n">ROSLauncher</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.core.helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_log_path</span><span class="p">,</span>
    <span class="n">load_ros_params_from_yaml</span><span class="p">,</span>
    <span class="n">ros_exit_gracefully</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.exceptions</span> <span class="kn">import</span> <span class="n">EePoseLookupError</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.robot_envs.panda_env</span> <span class="kn">import</span> <span class="n">PandaEnv</span>
<span class="kn">from</span> <span class="nn">rospy.exceptions</span> <span class="kn">import</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">ColorRGBA</span>

<span class="c1"># Specify topics and other script variables.</span>
<div class="viewcode-block" id="CONNECTION_TIMEOUT"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.CONNECTION_TIMEOUT">[docs]</a><span class="n">CONNECTION_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Timeout for connecting to services or topics.</span></div>
<div class="viewcode-block" id="MOVEIT_GET_RANDOM_JOINT_POSITIONS_TOPIC"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.MOVEIT_GET_RANDOM_JOINT_POSITIONS_TOPIC">[docs]</a><span class="n">MOVEIT_GET_RANDOM_JOINT_POSITIONS_TOPIC</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;panda_moveit_planner_server/get_random_joint_positions&quot;</span>
<span class="p">)</span></div>
<div class="viewcode-block" id="MOVEIT_SET_JOINT_POSITIONS_TOPIC"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.MOVEIT_SET_JOINT_POSITIONS_TOPIC">[docs]</a><span class="n">MOVEIT_SET_JOINT_POSITIONS_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;panda_moveit_planner_server/set_joint_positions&quot;</span></div>
<div class="viewcode-block" id="MOVEIT_GET_RANDOM_EE_POSE_TOPIC"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.MOVEIT_GET_RANDOM_EE_POSE_TOPIC">[docs]</a><span class="n">MOVEIT_GET_RANDOM_EE_POSE_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;panda_moveit_planner_server/get_random_ee_pose&quot;</span></div>
<div class="viewcode-block" id="MOVEIT_ADD_PLANE_TOPIC"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.MOVEIT_ADD_PLANE_TOPIC">[docs]</a><span class="n">MOVEIT_ADD_PLANE_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;panda_moveit_planner_server/planning_scene/add_plane&quot;</span></div>
<div class="viewcode-block" id="SET_FRANKA_MODEL_CONFIGURATION_TOPIC"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.SET_FRANKA_MODEL_CONFIGURATION_TOPIC">[docs]</a><span class="n">SET_FRANKA_MODEL_CONFIGURATION_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;set_franka_model_configuration&quot;</span></div>
<div class="viewcode-block" id="VALID_EE_CONTROL_JOINTS"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.VALID_EE_CONTROL_JOINTS">[docs]</a><span class="n">VALID_EE_CONTROL_JOINTS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;rx&quot;</span><span class="p">,</span> <span class="s2">&quot;ry&quot;</span><span class="p">,</span> <span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;rw&quot;</span><span class="p">]</span></div>
<div class="viewcode-block" id="CONFIG_FILE_PATH"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.CONFIG_FILE_PATH">[docs]</a><span class="n">CONFIG_FILE_PATH</span> <span class="o">=</span> <span class="s2">&quot;config/panda_reach.yaml&quot;</span></div>
<div class="viewcode-block" id="PANDA_REST_CONFIGURATION"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.PANDA_REST_CONFIGURATION">[docs]</a><span class="n">PANDA_REST_CONFIGURATION</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.57079632679</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mf">1.57079632679</span><span class="p">,</span>
    <span class="mf">0.785398163397</span><span class="p">,</span>
    <span class="mf">0.001</span><span class="p">,</span>
    <span class="mf">0.001</span><span class="p">,</span>
<span class="p">]</span></div>
<div class="viewcode-block" id="LOG_STEP_DEBUG_INFO"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.LOG_STEP_DEBUG_INFO">[docs]</a><span class="n">LOG_STEP_DEBUG_INFO</span> <span class="o">=</span> <span class="kc">False</span></div>
<div class="viewcode-block" id="AVAILABLE_HAND_COMMANDS"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.AVAILABLE_HAND_COMMANDS">[docs]</a><span class="n">AVAILABLE_HAND_COMMANDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">]</span></div>


<span class="c1">#################################################</span>
<span class="c1"># Panda reach environment class #################</span>
<span class="c1">#################################################</span>
<div class="viewcode-block" id="PandaReachEnv"><a class="viewcode-back" href="../../../../autoapi/ros_gazebo_gym/task_envs/panda/panda_reach/index.html#ros_gazebo_gym.task_envs.panda.PandaReachEnv">[docs]</a><span class="k">class</span> <span class="nc">PandaReachEnv</span><span class="p">(</span><span class="n">PandaEnv</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">EzPickle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class that provides all the methods used for the algorithm training.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        action_space (:obj:`gym.spaces.box.Box`): Gym action space object.</span>
<span class="sd">        observation_space (:obj:`gym.spaces.dict.Dict`): Gym observation space object.</span>
<span class="sd">        goal (:obj:`geometry_msgs.PoseStamped`): The current goal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_instance_count</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counts the number of instances that were created.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">control_type</span><span class="o">=</span><span class="s2">&quot;effort&quot;</span><span class="p">,</span>
        <span class="n">positive_reward</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">config_path</span><span class="o">=</span><span class="n">CONFIG_FILE_PATH</span><span class="p">,</span>
        <span class="n">gazebo_world_launch_file</span><span class="o">=</span><span class="s2">&quot;start_reach_world.launch&quot;</span><span class="p">,</span>
        <span class="n">visualize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">action_space_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">observation_space_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a Panda Task Environment.</span>

<span class="sd">        Args:</span>
<span class="sd">            control_Type (str, optional): The type of control you want to use for the</span>
<span class="sd">                panda robot (i.e. hand and arm). Options are: ``trajectory``,</span>
<span class="sd">                ``position``, ``effort`` or ``end_effector``. Defaults to ``effort``.</span>
<span class="sd">            positive_reward (bool, optional): Whether you want to use a positive</span>
<span class="sd">                reward instead of a negative reward. Defaults to ``False``.</span>
<span class="sd">            config_path (str, optional): Path where the environment configuration</span>
<span class="sd">                value are found. The path is resolved relative to the</span>
<span class="sd">                :class:`~ros_gazebo_gym.task_envs.panda.panda_reach` class file.</span>
<span class="sd">            gazebo_world_launch_file (str, optional): Name of the launch file that loads</span>
<span class="sd">                the gazebo world. Currently only the launch files inside the</span>
<span class="sd">                `panda_gazebo &lt;https://github.com/rickstaa/panda-gazebo&gt;`_ package are</span>
<span class="sd">                supported. Defaults to ``start_reach_world.launch``.</span>
<span class="sd">            visualize (bool, optional): Whether you want to show the RViz visualization.</span>
<span class="sd">                Defaults to ``None`` meaning the task configuration file values will</span>
<span class="sd">                be used.</span>
<span class="sd">            action_space_dtype (union[numpy.dtype, str], optional): The data type of the</span>
<span class="sd">                action space. Defaults to ``np.float64``.</span>
<span class="sd">            observation_space_dtype (union[numpy.dtype, str], optional): The data type</span>
<span class="sd">                of the observation space. Defaults to ``np.float64``.</span>

<span class="sd">        .. important::</span>
<span class="sd">            In this environment, the joint trajectory control is not implemented yet for</span>
<span class="sd">            multiple waypoints. This is because the action space only contains one</span>
<span class="sd">            waypoint. The :obj:`~PandaEnv.set_arm_joint_trajectory` method, however,</span>
<span class="sd">            already accepts multiple waypoints. As a result, task environment can be</span>
<span class="sd">            easily extended to work with multiple waypoints by modifying the</span>
<span class="sd">            :obj:`PandaReachEnv~._create_action_space` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Initialize PandaEnv task environment...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_instance_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_instance_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;You are trying to create multiple instances of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> class. Unfortunately, this is not yet &quot;</span>
                <span class="s2">&quot;been implemented and will cause unexpected behaviour. As a result, &quot;</span>
                <span class="s2">&quot;the script will be shut down. Feel free to open a pull request if &quot;</span>
                <span class="s2">&quot;you want to implement this functionality.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positive_reward</span> <span class="o">=</span> <span class="n">positive_reward</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_env</span> <span class="o">=</span> <span class="s2">&quot;panda_reach&quot;</span>

        <span class="c1"># Makes sure the env is pickable when it wraps C++ code.</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">EzPickle</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

        <span class="c1"># Makes sure roscore is running and ROS is initialized.</span>
        <span class="n">ROSLauncher</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="c1"># This is the path where the simulation files will be downloaded if not present.</span>
        <span class="n">workspace_path</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;/panda_reach_v0/workspace_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">workspace_path</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">workspace_path</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;The Simulation ROS Workspace path &quot;</span>
                <span class="o">+</span> <span class="n">workspace_path</span>
                <span class="o">+</span> <span class="s2">&quot; DOESN&#39;T exist, execute: mkdir -p &quot;</span>
                <span class="o">+</span> <span class="n">workspace_path</span>
                <span class="o">+</span> <span class="s2">&quot;/src;cd &quot;</span>
                <span class="o">+</span> <span class="n">workspace_path</span>
                <span class="o">+</span> <span class="s2">&quot;;catkin_make&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Load Params from the desired Yaml file relative to this TaskEnvironment.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Load Panda Reach parameters.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">load_ros_params_from_yaml</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span><span class="p">,</span>
            <span class="n">ros_package_name</span><span class="o">=</span><span class="s2">&quot;ros_gazebo_gym&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_params</span><span class="p">()</span>

        <span class="c1"># Thrown warning if gazebo is already running.</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;/gazebo&quot;</span> <span class="ow">in</span> <span class="n">topic</span> <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_published_topics</span><span class="p">())]</span>
        <span class="p">):</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since a Gazebo instance is &quot;</span>
                <span class="s2">&quot;already running. Unfortunately, spawning multiple Panda simulations &quot;</span>
                <span class="s2">&quot;is not yet supported. Please shut down this instance and try again.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Launch the panda task gazebo environment (Doesn&#39;t yet add the robot).</span>
        <span class="c1"># NOTE: This downloads and builds the required ROS packages if not found.</span>
        <span class="n">launch_log_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span>
                <span class="n">get_log_path</span><span class="p">()</span>
                <span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">gazebo_world_launch_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">_%m_%Y_%H_%M_%S&quot;</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roslaunch_log_to_console</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">ROSLauncher</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">package_name</span><span class="o">=</span><span class="s2">&quot;panda_gazebo&quot;</span><span class="p">,</span>
            <span class="n">launch_file_name</span><span class="o">=</span><span class="n">gazebo_world_launch_file</span><span class="p">,</span>
            <span class="n">workspace_path</span><span class="o">=</span><span class="n">workspace_path</span><span class="p">,</span>
            <span class="n">log_file</span><span class="o">=</span><span class="n">launch_log_file</span><span class="p">,</span>
            <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">outdated_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">paused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">gazebo_gui</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gazebo_gui</span><span class="p">,</span>
            <span class="n">physics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_physics</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Initiate Robot environments ##########</span>
        <span class="c1">########################################</span>

        <span class="c1"># Initialize the Robot environment.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PandaReachEnv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">robot_EE_link</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_link</span><span class="p">,</span>
            <span class="n">ee_frame_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="p">,</span>
            <span class="n">load_gripper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">,</span>
            <span class="n">lock_gripper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lock_gripper</span><span class="p">,</span>
            <span class="n">grasping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span><span class="p">,</span>
            <span class="n">control_type</span><span class="o">=</span><span class="n">control_type</span><span class="p">,</span>
            <span class="n">workspace_path</span><span class="o">=</span><span class="n">workspace_path</span><span class="p">,</span>
            <span class="n">log_reset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_reset</span><span class="p">,</span>
            <span class="n">visualize</span><span class="o">=</span><span class="n">visualize</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Disable visualize argument so that config can be used during inference.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ezpickle_kwargs</span><span class="p">[</span><span class="s2">&quot;visualize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialize task environment objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_done_samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">########################################</span>
        <span class="c1"># Connect to required services, ########</span>
        <span class="c1"># subscribers and publishers. ##########</span>
        <span class="c1">########################################</span>

        <span class="c1"># Connect to MoveIt &#39;get_random_joint_positions&#39; service.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">moveit_get_random_joint_positions_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVEIT_GET_RANDOM_JOINT_POSITIONS_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span>
                <span class="o">%</span> <span class="n">moveit_get_random_joint_positions_srv_topic</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                <span class="n">moveit_get_random_joint_positions_srv_topic</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">CONNECTION_TIMEOUT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_random_joint_positions_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">moveit_get_random_joint_positions_srv_topic</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">GetRandomJointPositions</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span>
                <span class="o">%</span> <span class="n">moveit_get_random_joint_positions_srv_topic</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to connect to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span>
                <span class="o">%</span> <span class="n">moveit_get_random_joint_positions_srv_topic</span>
            <span class="p">)</span>

        <span class="c1"># Connect to MoveIt &#39;get_random_ee_pose&#39; service.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">moveit_get_random_ee_pose_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVEIT_GET_RANDOM_EE_POSE_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span> <span class="o">%</span> <span class="n">moveit_get_random_ee_pose_srv_topic</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                <span class="n">moveit_get_random_ee_pose_srv_topic</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">CONNECTION_TIMEOUT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_random_ee_pose_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">moveit_get_random_ee_pose_srv_topic</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">GetRandomEePose</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">moveit_get_random_ee_pose_srv_topic</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to connect to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span>
                <span class="o">%</span> <span class="n">moveit_get_random_ee_pose_srv_topic</span>
            <span class="p">)</span>

        <span class="c1"># Connect to MoveIt &#39;planning_scene/add_plane&#39; service.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">moveit_add_plane_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVEIT_ADD_PLANE_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span> <span class="o">%</span> <span class="n">moveit_add_plane_srv_topic</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                <span class="n">moveit_add_plane_srv_topic</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">CONNECTION_TIMEOUT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_add_plane_srv</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">moveit_add_plane_srv_topic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">AddPlane</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">moveit_add_plane_srv_topic</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to connect to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">moveit_add_plane_srv_topic</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_init_pose_control</span><span class="p">:</span>
            <span class="c1"># Connect to MoveIt &#39;planning_scene/set_joint_positions&#39; service.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">moveit_set_joint_positions_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVEIT_SET_JOINT_POSITIONS_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                    <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span> <span class="o">%</span> <span class="n">moveit_set_joint_positions_srv_topic</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                    <span class="n">moveit_set_joint_positions_srv_topic</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">CONNECTION_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_set_joint_positions_srv</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                    <span class="n">moveit_set_joint_positions_srv_topic</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointPositions</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                    <span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">moveit_set_joint_positions_srv_topic</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to connect to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span>
                    <span class="o">%</span> <span class="n">moveit_set_joint_positions_srv_topic</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Connect to franka_gazebo&#39;s &#39;set_franka_model_configuration&#39; service.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">set_franka_model_configuration_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">SET_FRANKA_MODEL_CONFIGURATION_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                    <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span>
                    <span class="o">%</span> <span class="n">set_franka_model_configuration_srv_topic</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                    <span class="n">set_franka_model_configuration_srv_topic</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">CONNECTION_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_franka_model_configuration_srv</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                    <span class="n">set_franka_model_configuration_srv_topic</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">franka_msgs</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointConfiguration</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                    <span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span>
                    <span class="o">%</span> <span class="n">set_franka_model_configuration_srv_topic</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to connect to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span>
                    <span class="o">%</span> <span class="n">set_franka_model_configuration_srv_topic</span>
                <span class="p">)</span>

        <span class="c1"># Create current target publisher.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Creating target pose publisher.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_pose_marker_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
            <span class="s2">&quot;/ros_gazebo_gym/current_target&quot;</span><span class="p">,</span> <span class="n">TargetMarker</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">latch</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Goal target publisher created.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_rviz</span><span class="p">:</span>
            <span class="c1"># Create target bounding region publisher.</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Creating target bounding region publisher.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_sample_region_marker_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
                <span class="s2">&quot;/ros_gazebo_gym/target_sample_region&quot;</span><span class="p">,</span>
                <span class="n">SampleRegionMarker</span><span class="p">,</span>
                <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">latch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Target bounding region publisher created.&quot;</span><span class="p">)</span>

            <span class="c1"># Create initial pose bounding region publisher.</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Creating initial pose sample region publisher.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sample_region_marker__pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
                <span class="s2">&quot;/ros_gazebo_gym/init_pose_sample_region&quot;</span><span class="p">,</span>
                <span class="n">SampleRegionMarker</span><span class="p">,</span>
                <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">latch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Initial pose sample region publisher created.&quot;</span><span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Initialize RViz visualizations #######</span>
        <span class="c1">########################################</span>

        <span class="c1"># Add ground to MoveIt planning scene.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_ground_to_moveit_scene</span><span class="p">()</span>

        <span class="c1"># Add pose and target sampling bounds to RViz.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_rviz_visualizations</span><span class="p">()</span>

        <span class="c1">########################################</span>
        <span class="c1"># Create action and observation space ##</span>
        <span class="c1">########################################</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Setup gymnasium action and observation space.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_action_space_dtype</span> <span class="o">=</span> <span class="n">action_space_dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_space_dtype</span> <span class="o">=</span> <span class="n">observation_space_dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_dtype_conversion_warning</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_action_space</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_goal</span><span class="p">()</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_obs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">observation</span><span class="o">=</span><span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="n">shape</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;observation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_space_dtype</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">desired_goal</span><span class="o">=</span><span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="n">shape</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;desired_goal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_space_dtype</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">achieved_goal</span><span class="o">=</span><span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                    <span class="n">shape</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;achieved_goal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_space_dtype</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Throw warning if action space joints are locked.</span>
        <span class="n">locked_action_space_joints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">joint</span>
            <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">locked_action_space_joints</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The following joints in the action space are locked: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">list_2_human_text</span><span class="p">(</span><span class="n">locked_action_space_joints</span><span class="p">)</span><span class="si">}</span><span class="s2">. As a result, the &quot;</span>
                <span class="s2">&quot;control applied to these joints will not have any effect.&quot;</span>
            <span class="p">)</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;PandaEnv task environment initialized.&quot;</span><span class="p">)</span>

    <span class="c1">################################################</span>
    <span class="c1"># Task environment internal methods ############</span>
    <span class="c1">################################################</span>
    <span class="c1"># NOTE: Here you can add additional helper methods that are used in the task env.</span>

    <span class="k">def</span> <span class="nf">_init_rviz_visualizations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add pose and target sampling bounds to RViz.&quot;&quot;&quot;</span>
        <span class="c1"># Add goal sampling bounds to RViz.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span> <span class="o">!=</span> <span class="s2">&quot;fixed&quot;</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_rviz</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_target_sampling_bounds</span>
        <span class="p">):</span>
            <span class="n">goal_sample_region_marker_msg</span> <span class="o">=</span> <span class="n">SampleRegionMarker</span><span class="p">(</span>
                <span class="n">x_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span>
                <span class="n">y_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span>
                <span class="n">z_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;z_min&quot;</span><span class="p">],</span>
                <span class="n">x_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span>
                <span class="n">y_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">],</span>
                <span class="n">z_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;z_max&quot;</span><span class="p">],</span>
                <span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_sample_region_marker_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">goal_sample_region_marker_msg</span><span class="p">)</span>

        <span class="c1"># Add initial pose sampling region to RViz.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_rviz</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_init_pose_bounds</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_type</span> <span class="o">!=</span> <span class="s2">&quot;joint_positions&quot;</span>
        <span class="p">):</span>
            <span class="n">init_pose_sample_region_marker_msg</span> <span class="o">=</span> <span class="n">SampleRegionMarker</span><span class="p">(</span>
                <span class="n">x_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span>
                <span class="n">y_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span>
                <span class="n">z_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;z_min&quot;</span><span class="p">],</span>
                <span class="n">x_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span>
                <span class="n">y_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">],</span>
                <span class="n">z_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;z_max&quot;</span><span class="p">],</span>
                <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">init_pose_region_color</span> <span class="o">=</span> <span class="n">ColorRGBA</span><span class="p">()</span>
            <span class="n">init_pose_region_color</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0.15</span>
            <span class="n">init_pose_region_color</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">init_pose_region_color</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">init_pose_region_color</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">init_pose_sample_region_marker_msg</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">init_pose_region_color</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sample_region_marker__pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">init_pose_sample_region_marker_msg</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_ground_to_moveit_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds the ground to the MoveIt Planning scence.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_moveit_add_plane_srv&quot;</span><span class="p">):</span>
            <span class="n">add_ground_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">AddPlaneRequest</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ground&quot;</span><span class="p">,</span>
                <span class="n">pose</span><span class="o">=</span><span class="n">Pose</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="n">Quaternion</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">normal</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_add_plane_srv</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">add_ground_req</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span>
                    <span class="s2">&quot;The ground was not added successfully to the MoveIt planning &quot;</span>
                    <span class="s2">&quot;scene. As a result, MoveIt is unaware of the ground&#39;s existence &quot;</span>
                    <span class="s2">&quot;and may plan states that are in collision.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failled to connect to &#39;</span><span class="si">{</span><span class="n">MOVEIT_ADD_PLANE_TOPIC</span><span class="si">}</span><span class="s2">&#39; service! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; as this service is required for &quot;</span>
                <span class="s2">&quot;making MoveIt aware of the ground.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="s2">&quot;panda_reach&quot;</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve task environment configuration parameters from parameter server.</span>

<span class="sd">        Args:</span>
<span class="sd">            ns (str, optional): The namespace on which the parameters are found.</span>
<span class="sd">                Defaults to &quot;panda_reach&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_env</span> <span class="o">=</span> <span class="n">ns</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># == Retrieve control variables ==</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/direct_control&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/load_gripper&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock_gripper</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/lock_gripper&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ee_link</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/ee_link&quot;</span><span class="p">,</span>
                <span class="s2">&quot;panda_hand&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span> <span class="k">else</span> <span class="s2">&quot;panda_link8&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/grasping&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_wait</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/arm_wait&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hand_wait</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/hand_wait&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ee_control_coordinates</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/ee_control_coordinates&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_controlled_joints</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/controlled_joints&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/locked_arm_joints&quot;</span><span class="p">,</span> <span class="p">[]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/control/ee_frame_offset&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="p">[</span><span class="s2">&quot;rx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rx&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="p">[</span><span class="s2">&quot;ry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ry&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="p">[</span><span class="s2">&quot;rw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rw&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="c1"># == Retrieve sampling variables ==</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_init_pose_bounds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/visualize_init_pose_bounds&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_init_pose</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/reset_init_pose&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_random_init_pose</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/random_init_pose&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_randomize_first_episode</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/randomize_first_episode&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_attempts</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/attempts&quot;</span><span class="p">,</span> <span class="mi">10</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_type</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/pose_sampling_type&quot;</span><span class="p">,</span> <span class="s2">&quot;end_effector_pose&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_init_pose_control</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/moveit_control&quot;</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/init_pose&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.23</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.29</span><span class="p">,</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span>
                    <span class="s2">&quot;rx&quot;</span><span class="p">:</span> <span class="mf">0.78</span><span class="p">,</span>
                    <span class="s2">&quot;ry&quot;</span><span class="p">:</span> <span class="mf">0.62</span><span class="p">,</span>
                    <span class="s2">&quot;rz&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;rw&quot;</span><span class="p">:</span> <span class="mf">4.42</span><span class="p">,</span>
                    <span class="s2">&quot;panda_joint1&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;panda_joint2&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;panda_joint3&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;panda_joint4&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.57079632679</span><span class="p">,</span>
                    <span class="s2">&quot;panda_joint5&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;panda_joint6&quot;</span><span class="p">:</span> <span class="mf">1.57079632679</span><span class="p">,</span>
                    <span class="s2">&quot;panda_joint7&quot;</span><span class="p">:</span> <span class="mf">0.785398163397</span><span class="p">,</span>
                    <span class="s2">&quot;gripper_width&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_offset</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/offset&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/pose_sampling/bounds&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/target_sampling/strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_target</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/target_sampling/visualize_target&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_target_sampling_bounds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/target_sampling/visualize_target_bounds&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_offset</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/target_sampling/offset&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_target_pose</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/target_sampling/fixed_target&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span> <span class="o">!=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/target_sampling/bounds/&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">,</span>
                        <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                        <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">,</span>
                        <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                        <span class="s2">&quot;z_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;z_max&quot;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="c1"># == Retrieve reward variables ==</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reward_type</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/training/reward_type&quot;</span><span class="p">,</span> <span class="s2">&quot;sparse&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_hold</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/training/target_hold&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hold_samples</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/training/hold_samples&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_distance_threshold</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/training/distance_threshold&quot;</span><span class="p">,</span> <span class="mf">0.05</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collision_penalty</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/training/collision_penalty&quot;</span><span class="p">,</span> <span class="mf">0.0</span>
            <span class="p">)</span>
            <span class="c1"># == Retrieve environment variables ==</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pause_after_step</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/environment/pause_after_step&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_action_bounds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/environment/action_space/bounds&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;ee_pose&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">,</span>
                            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">,</span>
                            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="s2">&quot;rx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;ry&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;rz&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;rw&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
                            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
                            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
                            <span class="s2">&quot;rx&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s2">&quot;ry&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s2">&quot;rz&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s2">&quot;rw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;joint_positions&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;panda_joint1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.8973</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.7628</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint3&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.8973</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint4&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.0718</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint5&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.8973</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint6&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0175</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint7&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.8973</span><span class="p">,</span>
                            <span class="s2">&quot;gripper_width&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;panda_joint1&quot;</span><span class="p">:</span> <span class="mf">2.8973</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint2&quot;</span><span class="p">:</span> <span class="mf">1.7628</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint3&quot;</span><span class="p">:</span> <span class="mf">2.8973</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint4&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0698</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint5&quot;</span><span class="p">:</span> <span class="mf">2.8973</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint6&quot;</span><span class="p">:</span> <span class="mf">3.7525</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint7&quot;</span><span class="p">:</span> <span class="mf">2.8973</span><span class="p">,</span>
                            <span class="s2">&quot;gripper_width&quot;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;joint_efforts&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;panda_joint1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">87.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">87.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint3&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">87.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint4&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">87.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint5&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">12.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint6&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">12.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint7&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">12.0</span><span class="p">,</span>
                            <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;panda_joint1&quot;</span><span class="p">:</span> <span class="mf">87.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint2&quot;</span><span class="p">:</span> <span class="mf">87.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint3&quot;</span><span class="p">:</span> <span class="mf">87.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint4&quot;</span><span class="p">:</span> <span class="mf">87.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint5&quot;</span><span class="p">:</span> <span class="mf">12.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint6&quot;</span><span class="p">:</span> <span class="mf">12.0</span><span class="p">,</span>
                            <span class="s2">&quot;panda_joint7&quot;</span><span class="p">:</span> <span class="mf">12.0</span><span class="p">,</span>
                            <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">:</span> <span class="mi">140</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="c1"># == Retrieve global variables ==</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_physics</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/physics&quot;</span><span class="p">,</span> <span class="s2">&quot;ode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_rviz</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/load_rviz&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rviz_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/rviz_file&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config/moveit.rviz&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gazebo_gui</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/load_gazebo_gui&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_reset</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/log_reset&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_step_debug_info</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/log_step_debug_info&quot;</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_roslaunch_log_to_console</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/roslaunch_log_to_console&quot;</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="c1"># == Retrieve other variables ==</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_velocity_scaling_factor</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="s2">&quot;/panda_moveit_planner_server/max_velocity_scaling_factor&quot;</span><span class="p">,</span> <span class="mf">1.0</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_acceleration_scaling_factor</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                <span class="s2">&quot;/panda_moveit_planner_server/max_acceleration_scaling_factor&quot;</span><span class="p">,</span> <span class="mf">1.0</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; could not be retrieved from the parameter &quot;</span>
                <span class="s2">&quot;server. Please make sure this parameter is present in the Panda task &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;environment configuration file &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span><span class="si">}</span><span class="s2">&#39; and try &quot;</span>
                <span class="s2">&quot;again.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span>
                <span class="n">shutdown_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_robot_get_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all joint positions and velocities associated with a robot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`numpy.array`: Robot Positions, Robot Velocities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">position</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">velocity</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_goal_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_a</span><span class="p">,</span> <span class="n">goal_b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the perpendicular distance to the goal.</span>

<span class="sd">        Args:</span>
<span class="sd">            goal_a (:obj:`numpy.ndarray`): List containing a gripper and object pose.</span>
<span class="sd">            goal_b (:obj:`numpy.ndarray`): List containing a gripper and object pose.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`numpy.float32`: Perpendicular distance to the goal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">goal_a</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">goal_b</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">goal_a</span> <span class="o">-</span> <span class="n">goal_b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_random_joint_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get valid joint position commands for the Panda arm and hand.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing a valid joint position for each joint. Returns</span>
<span class="sd">                a empty dictionary if no valid joint positions were found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_moveit_get_random_joint_positions_client&quot;</span><span class="p">):</span>
            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">GetRandomJointPositionsRequest</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_attempts</span>

            <span class="c1"># Apply pose bounding region.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_init_pose_sampling_bounds&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">joint_positions_bound_region</span> <span class="o">=</span> <span class="n">split_bounds_dict</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span>
                <span class="p">)</span>
                <span class="n">joint_positions_bound_region</span> <span class="o">=</span> <span class="n">gripper_width_2_finger_joints_positions</span><span class="p">(</span>
                    <span class="n">joint_positions_bound_region</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">joint_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">JointLimits</span><span class="p">()</span>
                <span class="n">joint_limits</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_positions_bound_region</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">joint_limits</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_positions_bound_region</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">req</span><span class="o">.</span><span class="n">joint_limits</span> <span class="o">=</span> <span class="n">joint_limits</span>

            <span class="c1"># Retrieve random joint pose and return.</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_random_joint_positions_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="n">joint_positions_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">joint_names</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">joint_positions</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">joint_positions_dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;Invalid joint limits were given.&quot;</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The joint limits specified in the pose_sampling bounds &quot;</span>
                        <span class="s2">&quot;section of the task environment configuration file were &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;invalid &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;. Please make sure &quot;</span>
                        <span class="s2">&quot;that the pose_sampling joint limits are within the joint &quot;</span>
                        <span class="s2">&quot;limits specified in the panda robot description file.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to connect to &#39;</span><span class="si">{</span><span class="n">MOVEIT_GET_RANDOM_JOINT_POSITIONS_TOPIC</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;service! Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; as this service is &quot;</span>
                <span class="s2">&quot;required for retrieving random joint positions.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_random_ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a valid random EE pose that considers the boundaries set in the task</span>
<span class="sd">        environment configuration file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - random_ee_pose (dict): Random EE pose. A empty dictionary is returned</span>
<span class="sd">                  when no valid random EE pose could be found.</span>
<span class="sd">                - model_configuration (dict): A set of joint positions that result in</span>
<span class="sd">                  this EE pose. A empty dictionary is returned when no valid random</span>
<span class="sd">                  EE pose could be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_moveit_get_random_ee_pose_client&quot;</span><span class="p">):</span>
            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">GetRandomEePoseRequest</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_attempts</span>

            <span class="c1"># Apply pose bounding region.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_init_pose_sampling_bounds&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">ee_pose_bound_region</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">split_bounds_dict</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_sampling_bounds</span>
                <span class="p">)</span>
                <span class="n">req</span><span class="o">.</span><span class="n">bounding_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">BoundingRegion</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">ee_pose_bound_region</span>
                <span class="p">)</span>

            <span class="c1"># Retrieve random ee pose and return result.</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_random_ee_pose_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pose_msg_2_pose_dict</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">ee_pose</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">joint_names</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">joint_positions</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failled to connect to &#39;</span><span class="si">{</span><span class="n">MOVEIT_GET_RANDOM_EE_POSE_TOPIC</span><span class="si">}</span><span class="s2">&#39; service! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; as this service is required for &quot;</span>
                <span class="s2">&quot;retrieving a random end effector pose.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clip_goal_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Limit the possible goal position x, y and z values to a certian range.</span>

<span class="sd">        Args:</span>
<span class="sd">            goal_pose (:obj:`numpy.ndarray`): A numpy array containing the goal x,y and</span>
<span class="sd">                z values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;min&quot;</span> <span class="ow">in</span> <span class="n">key</span>
        <span class="p">]</span>
        <span class="n">max_bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;max&quot;</span> <span class="ow">in</span> <span class="n">key</span>
        <span class="p">]</span>
        <span class="n">clipped_goal_pose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="n">min_bounds</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">max_bounds</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">clipped_goal_pose</span> <span class="o">!=</span> <span class="n">goal_pose</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Goal pose clipped since it was not within the set target bounds.&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;New goal pose: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">clipped_goal_pose</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">clipped_goal_pose</span>

    <span class="k">def</span> <span class="nf">_check_config_action_space_joints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validates whether the &#39;ee_control_coordinates&#39; and &#39;controlled_joints&#39; fields</span>
<span class="sd">        in the task environment configuration file contain vallid joints/coordinates</span>
<span class="sd">        that can be used as action space joints.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SystemExit: Thrown when the coordinates/joints in the task environment</span>
<span class="sd">                config file are invalid. As a result the ROS script is shutdown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate EE coordinates.</span>
        <span class="n">invalid_ee_coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;end_effector&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_control_coordinates</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_control_coordinates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">joint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_EE_CONTROL_JOINTS</span><span class="p">:</span>
                        <span class="n">invalid_ee_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint</span><span class="p">)</span>

        <span class="c1"># Validate control_joints.</span>
        <span class="n">invalid_joints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controlled_joints</span><span class="p">:</span>
            <span class="n">valid_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">AVAILABLE_HAND_COMMANDS</span>
            <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controlled_joints</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">joint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_joints</span><span class="p">:</span>
                    <span class="n">invalid_joints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint</span><span class="p">)</span>

        <span class="c1"># Throw error and shutdown node if invalid joint was found.</span>
        <span class="k">if</span> <span class="n">invalid_ee_coordinates</span> <span class="ow">or</span> <span class="n">invalid_joints</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Shutting down &#39;</span><span class="si">%s</span><span class="s2">&#39; since the &quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">invalid_ee_coordinates</span> <span class="ow">and</span> <span class="n">invalid_joints</span><span class="p">:</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">([</span><span class="n">invalid_ee_coordinates</span><span class="p">,</span> <span class="n">invalid_joints</span><span class="p">])</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="n">list_2_human_text</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">invalid</span><span class="p">],</span>
                    <span class="n">end_seperator</span><span class="o">=</span><span class="s2">&quot;and&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> that </span><span class="si">%s</span><span class="s2"> specified in the &#39;ee_control_coordinates&#39; and &quot;</span>
                    <span class="s2">&quot;&#39;controlled_joints&#39; task environment config variables were &quot;</span>
                    <span class="s2">&quot;invalid.&quot;</span>
                <span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;coordinate/joint&quot;</span><span class="p">,</span> <span class="s2">&quot;was&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;coordinates/joints&quot;</span><span class="p">,</span> <span class="s2">&quot;were&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">invalid_ee_coordinates</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="n">list_2_human_text</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">invalid_ee_coordinates</span><span class="p">],</span>
                    <span class="n">end_seperator</span><span class="o">=</span><span class="s2">&quot;and&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> that </span><span class="si">%s</span><span class="s2"> specified in the &#39;ee_control_coordinates&#39; task &quot;</span>
                    <span class="s2">&quot;environment configuration variable </span><span class="si">%s</span><span class="s2"> invalid.&quot;</span>
                <span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;coordinate&quot;</span><span class="p">,</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_ee_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;were&quot;</span><span class="p">,</span> <span class="s2">&quot;are&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="n">list_2_human_text</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">invalid_joints</span><span class="p">],</span>
                    <span class="n">end_seperator</span><span class="o">=</span><span class="s2">&quot;and&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> that </span><span class="si">%s</span><span class="s2"> specified in the &#39;controlled_joints&#39; task &quot;</span>
                    <span class="s2">&quot;environment configuration variable </span><span class="si">%s</span><span class="s2"> invalid.&quot;</span>
                <span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;joint&quot;</span><span class="p">,</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_joints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;joints&quot;</span><span class="p">,</span> <span class="s2">&quot;were&quot;</span><span class="p">,</span> <span class="s2">&quot;are&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span>
                <span class="n">shutdown_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_action_space_joints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the joints that are being controlled when we sample from the action</span>
<span class="sd">        space.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Joints that are controlled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the action space joints set in the config file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_config_action_space_joints</span><span class="p">()</span>

        <span class="c1"># Get action space joints</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;end_effector&quot;</span><span class="p">:</span>
            <span class="c1"># Get end effector control coordinates.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_control_coordinates</span><span class="p">:</span>
                <span class="n">action_space_joints</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;rx&quot;</span><span class="p">,</span> <span class="s2">&quot;ry&quot;</span><span class="p">,</span> <span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;rw&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">action_space_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_control_coordinates</span>

            <span class="c1"># Get gripper control joints.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                <span class="n">action_space_joints</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controlled_joints</span><span class="p">:</span>
                <span class="n">controlled_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controlled_joints</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                    <span class="n">controlled_joints</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">item</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controlled_joints</span>
                        <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AVAILABLE_HAND_COMMANDS</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">controlled_joints</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_controlled_joints</span><span class="p">):</span>
                        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                            <span class="s2">&quot;Hand gripper commands were removed from the controlled &quot;</span>
                            <span class="s2">&quot;joints since the gripper is not loaded.&quot;</span>
                        <span class="p">)</span>
                <span class="n">action_space_joints</span> <span class="o">=</span> <span class="n">controlled_joints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">action_space_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                    <span class="n">action_space_joints</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">AVAILABLE_HAND_COMMANDS</span><span class="p">,</span> <span class="n">action_space_joints</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">]</span>
                        <span class="k">else</span> <span class="p">[</span><span class="n">action_space_joints</span><span class="p">,</span> <span class="n">AVAILABLE_HAND_COMMANDS</span><span class="p">]</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">action_space_joints</span>

    <span class="k">def</span> <span class="nf">_create_action_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the action space based on the action space size and the action bounds.</span>

<span class="sd">        Args:</span>
<span class="sd">            dtype (numpy.dtype, optional): The data type of the action space. Defaults</span>
<span class="sd">                to np.float64.</span>
<span class="sd">        Returns:</span>
<span class="sd">            :obj:`gym.spaces.Box`: The gymnasium action space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve action space joints if not supplied.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_action_space_joints</span><span class="p">()</span>

        <span class="c1"># Set action space bounds based on control_type.</span>
        <span class="n">arm_bounds_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ee_pose&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;end_effector&quot;</span>
            <span class="k">else</span> <span class="p">(</span>
                <span class="s2">&quot;joint_efforts&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;effort&quot;</span>
                <span class="k">else</span> <span class="s2">&quot;joint_positions&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">arm_action_bounds_low</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">joint</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_bounds</span><span class="p">[</span><span class="n">arm_bounds_key</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="o">!=</span> <span class="s2">&quot;gripper_max_effort&quot;</span>
        <span class="p">}</span>
        <span class="n">gripper_with_action_bound_low</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">joint</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_bounds</span><span class="p">[</span><span class="s2">&quot;joint_positions&quot;</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="o">==</span> <span class="s2">&quot;gripper_width&quot;</span>
        <span class="p">}</span>
        <span class="n">gripper_max_effort_action_bound_low</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">joint</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_bounds</span><span class="p">[</span><span class="s2">&quot;joint_efforts&quot;</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="o">==</span> <span class="s2">&quot;gripper_max_effort&quot;</span>
        <span class="p">}</span>
        <span class="n">action_bounds_low</span> <span class="o">=</span> <span class="n">shallow_dict_merge</span><span class="p">(</span>
            <span class="n">arm_action_bounds_low</span><span class="p">,</span>
            <span class="n">gripper_with_action_bound_low</span><span class="p">,</span>
            <span class="n">gripper_max_effort_action_bound_low</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">arm_action_bounds_high</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">joint</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_bounds</span><span class="p">[</span><span class="n">arm_bounds_key</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="o">!=</span> <span class="s2">&quot;gripper_max_effort&quot;</span>
        <span class="p">}</span>
        <span class="n">gripper_with_action_bound_high</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">joint</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_bounds</span><span class="p">[</span><span class="s2">&quot;joint_positions&quot;</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="o">==</span> <span class="s2">&quot;gripper_width&quot;</span>
        <span class="p">}</span>
        <span class="n">gripper_max_effort_action_bound_high</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">joint</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_bounds</span><span class="p">[</span><span class="s2">&quot;joint_efforts&quot;</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="o">==</span> <span class="s2">&quot;gripper_max_effort&quot;</span>
        <span class="p">}</span>
        <span class="n">action_bounds_high</span> <span class="o">=</span> <span class="n">shallow_dict_merge</span><span class="p">(</span>
            <span class="n">arm_action_bounds_high</span><span class="p">,</span>
            <span class="n">gripper_with_action_bound_high</span><span class="p">,</span>
            <span class="n">gripper_max_effort_action_bound_high</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">action_bound_low_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">val</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">action_bounds_low</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">action_bound_high_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">val</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">action_bounds_high</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create action space.</span>
        <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="n">action_bound_low_filtered</span><span class="p">,</span>
            <span class="n">action_bound_high_filtered</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">action_bound_low_filtered</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_panda_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_names</span><span class="p">,</span> <span class="n">joint_positions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the panda robot to a given configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_positions (list): The desired joint positions.</span>
<span class="sd">            joint_names (list): The joint names for which you want to set the joint</span>
<span class="sd">                position.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the panda configuration was successfully set.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Here we use the ``/set_franka_model_configuration`` service instead of the</span>
<span class="sd">            Gazebo&#39;s ``set_model_configuration``. This was done because the latter</span>
<span class="sd">            causes the reported joint positions outside the joint limits. For more</span>
<span class="sd">            information, see</span>
<span class="sd">            `https://github.com/frankaemika/franka_ros/issues/225 &lt;https://github.com/frankaemika/franka_ros/issues/225&gt;`_.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_set_franka_model_configuration_srv&quot;</span><span class="p">):</span>
            <span class="c1"># Unlock locked joints.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unlock_joints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span><span class="p">)</span>

            <span class="c1"># Set joint configuration.</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_franka_model_configuration_srv</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">franka_msgs</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointConfigurationRequest</span><span class="p">(</span>
                    <span class="n">joint_names</span><span class="o">=</span><span class="n">joint_names</span><span class="p">,</span> <span class="n">joint_positions</span><span class="o">=</span><span class="n">joint_positions</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span>

            <span class="c1"># Lock locked joints.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock_joints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                <span class="s2">&quot;Panda configuration not set as &#39;set_franka_model_configuration&#39; &quot;</span>
                <span class="s2">&quot;service is not available.&quot;</span>
            <span class="p">)</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">retval</span>

    <span class="c1">################################################</span>
    <span class="c1"># Overload Robot env virtual methods ###########</span>
    <span class="c1">################################################</span>
    <span class="c1"># NOTE: Methods that need to be implemented as they are called by the robot and</span>
    <span class="c1"># gazebo environments.</span>
    <span class="k">def</span> <span class="nf">_compute_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observations</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the reward.</span>

<span class="sd">        Args:</span>
<span class="sd">            observations (dict): Dictionary containing the observations.</span>
<span class="sd">            done (bool): Boolean specifying whether an episode is terminated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`numpy.float32`: Reward that is received by the agent.</span>

<span class="sd">        .. attention::</span>
<span class="sd">            The ``done`` argument is not used for computing the reward in this task</span>
<span class="sd">            environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate the rewards based on the distance from the goal.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_goal_distance</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="s2">&quot;achieved_goal&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reward_type</span> <span class="o">==</span> <span class="s2">&quot;sparse&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collision_penalty</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_collision</span><span class="p">:</span>
                <span class="n">reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reward</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;=Reward info=&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Reward type: Non sparse&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Goal: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Achieved goal: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">observations</span><span class="p">[</span><span class="s2">&quot;achieved_goal&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Perpendicular distance: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Threshold: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_threshold</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span>
                <span class="s2">&quot;Received reward: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">reward</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_reward</span> <span class="k">else</span> <span class="n">reward</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;=Reward info=&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Reward type: Sparse&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Goal: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Achieved goal: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">observations</span><span class="p">[</span><span class="s2">&quot;achieved_goal&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Perpendicular distance: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Threshold: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_threshold</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Received reward: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">)</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collision_penalty</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_collision</span><span class="p">:</span>
                <span class="n">reward</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collision_penalty</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_reward</span> <span class="k">else</span> <span class="n">reward</span>

    <span class="k">def</span> <span class="nf">_get_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get robot state observation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple containing:</span>

<span class="sd">                - observation array (:obj:`list`):</span>
<span class="sd">                    List of observations:</span>
<span class="sd">                        - End effector x position</span>
<span class="sd">                        - End effector y position</span>
<span class="sd">                        - End effector z position</span>
<span class="sd">                        - End effector joints positions</span>
<span class="sd">                        - End effector joints velocities</span>
<span class="sd">                - achieved_goal (:obj:`object`): The goal that was achieved during</span>
<span class="sd">                  execution.</span>
<span class="sd">                - desired_goal (:obj:`object`): The desired goal that we asked the agent</span>
<span class="sd">                  to attempt to achieve.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ee_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
        <span class="n">ee_position</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">robot_qpos</span><span class="p">,</span> <span class="n">robot_qvel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot_get_obs</span><span class="p">()</span>
        <span class="n">ee_state</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pos</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">robot_qpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;panda_finger&quot;</span> <span class="ow">in</span> <span class="n">name</span>
        <span class="p">]</span>
        <span class="n">ee_vel</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">vel</span>
            <span class="k">for</span> <span class="n">vel</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">robot_qvel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;panda_finger&quot;</span> <span class="ow">in</span> <span class="n">name</span>
        <span class="p">]</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">ee_position</span><span class="p">,</span>
                <span class="n">ee_state</span><span class="p">,</span>
                <span class="n">ee_vel</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_space_dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">achieved_goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ee_position</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_space_dtype</span><span class="p">)</span>
        <span class="n">desired_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_space_dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;observation&quot;</span><span class="p">:</span> <span class="n">obs</span><span class="p">,</span>
            <span class="s2">&quot;achieved_goal&quot;</span><span class="p">:</span> <span class="n">achieved_goal</span><span class="p">,</span>
            <span class="s2">&quot;desired_goal&quot;</span><span class="p">:</span> <span class="n">desired_goal</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary with additional step information.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary with additional information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ee_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
        <span class="n">ee_position</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
            <span class="s2">&quot;state_of_interest&quot;</span><span class="p">:</span> <span class="n">ee_position</span><span class="p">,</span>
            <span class="s2">&quot;reference_error&quot;</span><span class="p">:</span> <span class="n">ee_position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">_set_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take robot action.</span>

<span class="sd">        Args:</span>
<span class="sd">            action (numpy.ndarray): List containing joint or ee action commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Throw error and shutdown if action space is not the right size.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since the shape of the supplied &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;action </span><span class="si">{</span><span class="n">action</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> while the gymnasium action space has shape &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Change action dtype if needed and throw one time warning.</span>
        <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_space_dtype</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_dtype_conversion_warning</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;The data type of the action that is supplied to the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;ros_gazebo_gym:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; environment (</span><span class="si">{</span><span class="n">action</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">) &quot;</span>
                    <span class="s2">&quot;does not match the data type of the action space &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_dtype</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">). The action data type will &quot;</span>
                    <span class="s2">&quot;be converted to the action space data type.&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_action_dtype_conversion_warning</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_dtype</span><span class="p">)</span>

        <span class="c1"># Send action commands to the controllers based on control type.</span>
        <span class="n">action_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">,</span> <span class="n">action</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;=Action set info=&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Action that is set:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">action_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;end_effector&quot;</span><span class="p">,</span> <span class="s2">&quot;trajectory&quot;</span><span class="p">]:</span>
            <span class="n">gripper_with</span> <span class="o">=</span> <span class="n">action_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">gripper_max_effort</span> <span class="o">=</span> <span class="n">action_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;end_effector&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_ee_pose</span><span class="p">(</span><span class="n">action_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_gripper</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_gripper_width</span><span class="p">(</span>
                        <span class="n">gripper_with</span><span class="p">,</span>
                        <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hand_wait</span><span class="p">,</span>
                        <span class="n">max_effort</span><span class="o">=</span><span class="n">gripper_max_effort</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_arm_joint_trajectory</span><span class="p">(</span><span class="n">action_dict</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_arm_wait</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_gripper</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_gripper_width</span><span class="p">(</span>
                        <span class="n">gripper_with</span><span class="p">,</span>
                        <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hand_wait</span><span class="p">,</span>
                        <span class="n">max_effort</span><span class="o">=</span><span class="n">gripper_max_effort</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_gripper</span><span class="p">:</span>
                <span class="n">action_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">action_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_joint_commands</span><span class="p">(</span>
                <span class="n">action_dict</span><span class="p">,</span> <span class="n">arm_wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_arm_wait</span><span class="p">,</span> <span class="n">hand_wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hand_wait</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observations</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if task is done.</span>

<span class="sd">        Args:</span>
<span class="sd">            observations (dict): Dictionary containing the observations</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying whether the episode is done (e.i. distance to the</span>
<span class="sd">                goal is within the distance threshold, robot has fallen etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if gripper is within range of the goal.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_goal_distance</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="s2">&quot;achieved_goal&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
        <span class="n">is_done</span> <span class="o">=</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_threshold</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;=Task is done info=&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_hold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_done</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_done_samples</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_done_samples</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_samples</span><span class="p">:</span>
                    <span class="n">is_done</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Agent spend &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_done_samples</span><span class="si">}</span><span class="s2">&#39; within target position.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Task is done.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_done_samples</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Task is not done.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_done_samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_done</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Task is done.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span><span class="s2">&quot;Task is not done.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">is_done</span>

    <span class="k">def</span> <span class="nf">_sample_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample a random goal position.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`geometry_msgs.PoseStamped`: A goal pose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Sampling goal.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
            <span class="n">goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;z_min&quot;</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;z_max&quot;</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>  <span class="c1"># Rel to current EE pose.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cur_ee_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
                <span class="n">cur_ee_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">EePoseLookupError</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since the current end &quot;</span>
                    <span class="s2">&quot;effector pose which is needed for sampling the goals could &quot;</span>
                    <span class="s2">&quot;not be retrieved.&quot;</span>
                <span class="p">)</span>
                <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Sample goal relative to end effector pose.</span>
            <span class="n">goal</span> <span class="o">=</span> <span class="n">cur_ee_position</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;z_min&quot;</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_bounds</span><span class="p">[</span><span class="s2">&quot;z_max&quot;</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="n">size</span><span class="o">=</span><span class="n">cur_ee_position</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span> <span class="o">==</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
            <span class="n">goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_target_pose</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Thrown error if goal could not be sampled.</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since no goal could be sampled &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;as &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span><span class="si">}</span><span class="s2">&#39; is not a valid goal sampling &quot;</span>
                <span class="s2">&quot;strategy. Options are &#39;global&#39; and &#39;local&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Make sure the goal is always within the sampling region.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_sampling_strategy</span> <span class="o">!=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
            <span class="n">goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_goal_position</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Goal: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">goal</span><span class="p">)</span>

        <span class="c1"># Apply offset and return goal.</span>
        <span class="n">goal</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_target_offset</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_target_offset</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_target_offset</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">goal</span>

    <span class="k">def</span> <span class="nf">_visualize_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize RViz goal marker.</span>

<span class="sd">        Args:</span>
<span class="sd">            offset (list): Position offset for visualizing the goal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">goal_marker_msg</span> <span class="o">=</span> <span class="n">TargetMarker</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">goal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">goal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">goal</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_pose_marker_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">goal_marker_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_init_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the Robot in its (random) initial pose.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying whether the initial pose was successfully set.</span>

<span class="sd">        .. note::</span>
<span class="sd">           The pose is sampled based on the ``pose_sampling_type`` variable set in the</span>
<span class="sd">           task environment configuration file. Options are ``end_effector_pose``,</span>
<span class="sd">           which creates a random pose by sampling EE poses, and ``joint_positions``,</span>
<span class="sd">           which makes a random pose by sampling joint positions. These methods respect</span>
<span class="sd">           the ``bounds`` set in the task environment config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_init_pose</span><span class="p">:</span>
            <span class="n">init_type</span> <span class="o">=</span> <span class="s2">&quot;random &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_init_pose</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting </span><span class="si">{</span><span class="n">init_type</span><span class="si">}</span><span class="s2">init pose...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_init_pose</span><span class="p">:</span>  <span class="c1"># Use random initial model configuration.</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_type</span> <span class="o">==</span> <span class="s2">&quot;joint_positions&quot;</span>
                <span class="p">):</span>  <span class="c1"># Sample random joint positions.</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Retrieve random joint positions.&quot;</span><span class="p">)</span>
                    <span class="n">random_joint_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_random_joint_positions</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">random_joint_positions</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                            <span class="n">random_joint_positions</span><span class="p">[</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">split_pose_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_gripper</span>
                                <span class="k">else</span> <span class="n">random_joint_positions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span>
                                <span class="p">)</span>
                                <span class="o">*</span> <span class="mi">2</span>
                            <span class="p">)</span>
                            <span class="n">random_joint_positions</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="n">joint</span><span class="p">:</span> <span class="n">position</span>
                                <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">random_joint_positions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">joint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">]</span>
                            <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Sample random EE poses.</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_randomize_first_episode</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_num</span> <span class="o">!=</span> <span class="mi">0</span>
                    <span class="p">):</span>  <span class="c1"># Retrieve random EE pose.</span>
                        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Retrieve random EE pose.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_panda_configuration</span><span class="p">(</span>
                            <span class="n">joint_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">],</span>
                            <span class="n">joint_positions</span><span class="o">=</span><span class="n">PANDA_REST_CONFIGURATION</span><span class="p">[</span>
                                <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">])</span>
                            <span class="p">],</span>
                        <span class="p">)</span>  <span class="c1"># NOTE: Done as joint conflicts might prevent planning.</span>
                        <span class="p">(</span>
                            <span class="n">random_ee_pose</span><span class="p">,</span>
                            <span class="n">random_joint_positions</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_random_ee_pose</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Use fixed initial arm/hand initial EE pose.</span>
                        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Retrieving initial EE pose.&quot;</span><span class="p">)</span>
                        <span class="n">random_ee_pose</span> <span class="o">=</span> <span class="n">split_pose_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">random_joint_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose_joint_config</span><span class="p">(</span>
                            <span class="n">random_ee_pose</span>
                        <span class="p">)</span>

                    <span class="c1"># Apply init pose offset.</span>
                    <span class="k">if</span> <span class="n">random_ee_pose</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_offset</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Applying offset to initial pose.&quot;</span><span class="p">)</span>
                        <span class="n">random_ee_pose</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_offset</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
                        <span class="n">random_ee_pose</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_offset</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
                        <span class="n">random_ee_pose</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose_offset</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>

                        <span class="c1"># Retrieve model configuration for the new EE pose.</span>
                        <span class="n">ee_pose_joint_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose_joint_config</span><span class="p">(</span>
                            <span class="n">random_ee_pose</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ee_pose_joint_positions</span><span class="p">:</span>
                            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                                <span class="s2">&quot;Could not retrieve a model configuration that relates &quot;</span>
                                <span class="s2">&quot;to the EE pose with the offset. As a result the model &quot;</span>
                                <span class="s2">&quot;configuration for the EE pose without the offset is &quot;</span>
                                <span class="s2">&quot;used.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">random_joint_positions</span> <span class="o">=</span> <span class="n">ee_pose_joint_positions</span>

                    <span class="c1"># Retrieve random gripper width.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                        <span class="n">random_joint_positions</span><span class="p">[</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">split_pose_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_gripper</span>
                            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_random_joint_positions</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span>
                            <span class="p">)</span>
                            <span class="o">*</span> <span class="mi">2</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Use fixed initial pose.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_type</span> <span class="o">==</span> <span class="s2">&quot;joint_positions&quot;</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Retrieving initial joint positions.&quot;</span><span class="p">)</span>
                    <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span> <span class="o">=</span> <span class="n">split_pose_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Retrieving initial EE pose.&quot;</span><span class="p">)</span>
                    <span class="n">random_joint_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose_joint_config</span><span class="p">(</span>
                        <span class="n">split_pose_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_pose</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">random_joint_positions</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                            <span class="n">random_joint_positions</span><span class="p">[</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_pose_dict</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_init_pose</span>
                            <span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">random_joint_positions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                            <span class="nb">zip</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">],</span>
                                <span class="n">PANDA_REST_CONFIGURATION</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">])],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                            <span class="s2">&quot;No valid joint positions could be retrieved for the EE &quot;</span>
                            <span class="s2">&quot;pose specified in the &#39;init_pose&#39; field of the task &quot;</span>
                            <span class="s2">&quot;configuration file. As a &quot;</span>
                            <span class="s2">&quot;result the fallback model configuration was used &quot;</span>
                            <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">random_joint_positions</span><span class="p">)</span>
                        <span class="p">)</span>

            <span class="c1"># Check if a valid model configuration was found.</span>
            <span class="k">if</span> <span class="n">random_joint_positions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span> <span class="o">=</span> <span class="n">random_joint_positions</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pose_sampling_type_str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;joint positions&quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_type</span> <span class="o">==</span> <span class="s2">&quot;joint_positions&quot;</span>
                    <span class="k">else</span> <span class="s2">&quot;EE pose&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to retrieve a valid random </span><span class="si">{</span><span class="n">pose_sampling_type_str</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="s2">&quot;Please ensure that you have set valid pose_sampling bounds in &quot;</span>
                        <span class="s2">&quot;the task environment config file &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;. The initial model &quot;</span>
                        <span class="s2">&quot;configuration from the previous episode was used as a result.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">],</span>
                            <span class="n">PANDA_REST_CONFIGURATION</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">])],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to retrieve a valid random </span><span class="si">{</span><span class="n">pose_sampling_type_str</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="s2">&quot;Please ensure that you have set valid pose_sampling bounds in &quot;</span>
                        <span class="s2">&quot;the task environment config file &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;. Because no previous &quot;</span>
                        <span class="s2">&quot;initial model configuration was available the fallback model &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;configuration &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span><span class="si">}</span><span class="s2">&#39; was used.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Convert gripper width to joint positions.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">gripper_width_2_finger_joints_positions</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Set initial model configuration and return result</span>
            <span class="c1"># NOTE: Here two modes can be used: MoveIT or Gazebo&#39;s</span>
            <span class="c1"># &#39;set_model_configuration&#39; service.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_init_pose_control</span><span class="p">:</span>  <span class="c1"># Use Gazebo service.</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Setting initial robot pose.&quot;</span><span class="p">)</span>
                <span class="n">init_pose_retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_panda_configuration</span><span class="p">(</span>
                    <span class="n">joint_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="n">joint_positions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">init_pose_retval</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Setting initial robot pose failed.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">init_pose_retval</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Use MoveIt.</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_moveit_set_joint_positions_srv&quot;</span><span class="p">):</span>
                    <span class="n">prev_control_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">=</span> <span class="s2">&quot;trajectory&quot;</span>

                    <span class="c1"># Unlock locked joints.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unlock_joints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span><span class="p">)</span>

                    <span class="c1"># Set initial model configuration.</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_set_joint_positions_srv</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointPositionsRequest</span><span class="p">(</span>
                            <span class="n">joint_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                            <span class="n">joint_positions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_model_configuration</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                            <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">=</span> <span class="n">prev_control_type</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Setting initial robot pose failed.&quot;</span><span class="p">)</span>

                    <span class="c1"># Lock locked joints.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lock_joints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_locked_arm_joints</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;The initial pose failed since the </span><span class="si">{}</span><span class="s2"> service was not &quot;</span>
                    <span class="s2">&quot;available.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MOVEIT_SET_JOINT_POSITIONS_TOPIC</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_init_env_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inits variables needed to be initialized each time we reset at the start</span>
<span class="sd">        of an episode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sample and visualize goal.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_goal</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualize_goal</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Rick Staa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>