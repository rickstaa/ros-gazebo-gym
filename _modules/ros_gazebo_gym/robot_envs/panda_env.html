<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ros_gazebo_gym.robot_envs.panda_env &mdash; ROS Gazebo Gym 2.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/modify.css?v=519ed47b" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=d7b522e2"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/usage.html">How to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/envs.html">Environments</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/contributing.html">Contribute to ros-gazebo-gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/add_nev_env.html">Add new environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/doc_dev.html">Release documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/openai_ros_diff.html">Difference with openai_ros</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../etc/acknowledgements.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ROS Gazebo Gym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../ros_gazebo_gym.html">ros_gazebo_gym</a></li>
      <li class="breadcrumb-item active">ros_gazebo_gym.robot_envs.panda_env</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ros_gazebo_gym.robot_envs.panda_env</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Robot environment for the</span>
<span class="sd">`Panda Emika Franka Simulation &lt;https://ros-planning.github.io/moveit_tutorials/doc/gazebo_simulation/gazebo_simulation.html&gt;`_.</span>

<span class="sd">.. note::</span>
<span class="sd">    The panda robot environment contains two methods of controlling the robot: ``DIRECT``</span>
<span class="sd">    control (Default) and ``PROXY`` based control. Initially, I abstracted all the panda</span>
<span class="sd">    control logic away in the :panda-gazebo:`panda_gazebo &lt;&gt;` package and made it</span>
<span class="sd">    available through services. Later, however, I found that the service calls slowed</span>
<span class="sd">    down the control. I then added the DIRECT control method, which directly publishes</span>
<span class="sd">    the control commands on the controller ``command`` topic. This control method made</span>
<span class="sd">    the training loop two times faster. Currently, the ``DIRECT`` mode is only available</span>
<span class="sd">    for the ``position`` and ``effort`` control. Other control methods like</span>
<span class="sd">    ``trajectory`` and ``end_effector`` control will use the PROXY based method.</span>
<span class="sd">&quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">compress</span>

<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">tf2_ros</span>
<span class="kn">from</span> <span class="nn">control_msgs.msg</span> <span class="kn">import</span> <span class="n">GripperCommandAction</span><span class="p">,</span> <span class="n">GripperCommandGoal</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Pose</span><span class="p">,</span>
    <span class="n">Quaternion</span><span class="p">,</span>
    <span class="n">Vector3</span><span class="p">,</span>
    <span class="n">TransformStamped</span><span class="p">,</span>
    <span class="n">Transform</span><span class="p">,</span>
    <span class="n">Point</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tf.transformations</span> <span class="kn">import</span> <span class="n">quaternion_inverse</span><span class="p">,</span> <span class="n">quaternion_multiply</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.common.helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">action_server_exists</span><span class="p">,</span>
    <span class="n">flatten_list</span><span class="p">,</span>
    <span class="n">get_orientation_euler</span><span class="p">,</span>
    <span class="n">is_sublist</span><span class="p">,</span>
    <span class="n">list_2_human_text</span><span class="p">,</span>
    <span class="n">lower_first_char</span><span class="p">,</span>
    <span class="n">normalize_quaternion</span><span class="p">,</span>
    <span class="n">suppress_stderr</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.core.helpers</span> <span class="kn">import</span> <span class="n">get_log_path</span><span class="p">,</span> <span class="n">ros_exit_gracefully</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.core.lazy_importer</span> <span class="kn">import</span> <span class="n">LazyImporter</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.core.ros_launcher</span> <span class="kn">import</span> <span class="n">ROSLauncher</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.exceptions</span> <span class="kn">import</span> <span class="n">EePoseLookupError</span><span class="p">,</span> <span class="n">EeRpyLookupError</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.robot_envs.helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">remove_gripper_commands_from_joint_commands_msg</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ros_gazebo_gym.robot_gazebo_goal_env</span> <span class="kn">import</span> <span class="n">RobotGazeboGoalEnv</span>
<span class="kn">from</span> <span class="nn">rospy.exceptions</span> <span class="kn">import</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">JointState</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Float32</span><span class="p">,</span> <span class="n">Float64MultiArray</span><span class="p">,</span> <span class="n">Header</span>
<span class="kn">from</span> <span class="nn">urdf_parser_py.urdf</span> <span class="kn">import</span> <span class="n">URDF</span>
<span class="kn">from</span> <span class="nn">tf2_geometry_msgs</span> <span class="kn">import</span> <span class="n">PoseStamped</span>
<span class="kn">from</span> <span class="nn">tf2_ros</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StaticTransformBroadcaster</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Specify topics and connection timeouts.</span>
<div class="viewcode-block" id="CONNECTION_TIMEOUT"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.CONNECTION_TIMEOUT">[docs]</a><span class="n">CONNECTION_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Timeout for connecting to services or topics.</span></div>
<div class="viewcode-block" id="GAZEBO_SIM_CONNECTION_TIMEOUT"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.GAZEBO_SIM_CONNECTION_TIMEOUT">[docs]</a><span class="n">GAZEBO_SIM_CONNECTION_TIMEOUT</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># Timeout for waiting for gazebo to be launched.</span></div>
<div class="viewcode-block" id="MOVEIT_SET_EE_POSE_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.MOVEIT_SET_EE_POSE_TOPIC">[docs]</a><span class="n">MOVEIT_SET_EE_POSE_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;panda_moveit_planner_server/panda_arm/set_ee_pose&quot;</span></div>
<div class="viewcode-block" id="MOVEIT_GET_EE_POSE_JOINT_CONFIG_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.MOVEIT_GET_EE_POSE_JOINT_CONFIG_TOPIC">[docs]</a><span class="n">MOVEIT_GET_EE_POSE_JOINT_CONFIG_TOPIC</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;panda_moveit_planner_server/panda_arm/get_ee_pose_joint_config&quot;</span>
<span class="p">)</span></div>
<div class="viewcode-block" id="LOCK_UNLOCK_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.LOCK_UNLOCK_TOPIC">[docs]</a><span class="n">LOCK_UNLOCK_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;lock_unlock_panda_joints&quot;</span></div>
<div class="viewcode-block" id="GET_CONTROLLED_JOINTS_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.GET_CONTROLLED_JOINTS_TOPIC">[docs]</a><span class="n">GET_CONTROLLED_JOINTS_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;panda_control_server/get_controlled_joints&quot;</span></div>
<div class="viewcode-block" id="SET_JOINT_COMMANDS_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.SET_JOINT_COMMANDS_TOPIC">[docs]</a><span class="n">SET_JOINT_COMMANDS_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;panda_control_server/set_joint_commands&quot;</span></div>
<div class="viewcode-block" id="SET_GRIPPER_WIDTH_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.SET_GRIPPER_WIDTH_TOPIC">[docs]</a><span class="n">SET_GRIPPER_WIDTH_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;panda_control_server/panda_hand/set_gripper_width&quot;</span></div>
<div class="viewcode-block" id="SET_JOINT_TRAJECTORY_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.SET_JOINT_TRAJECTORY_TOPIC">[docs]</a><span class="n">SET_JOINT_TRAJECTORY_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;panda_control_server/panda_arm/follow_joint_trajectory&quot;</span></div>
<div class="viewcode-block" id="FRANKA_GRIPPER_COMMAND_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.FRANKA_GRIPPER_COMMAND_TOPIC">[docs]</a><span class="n">FRANKA_GRIPPER_COMMAND_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;franka_gripper/gripper_action&quot;</span></div>
<div class="viewcode-block" id="JOINT_STATES_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.JOINT_STATES_TOPIC">[docs]</a><span class="n">JOINT_STATES_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;joint_states&quot;</span></div>
<div class="viewcode-block" id="FRANKA_STATES_TOPIC"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.FRANKA_STATES_TOPIC">[docs]</a><span class="n">FRANKA_STATES_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;franka_state_controller/franka_states&quot;</span></div>
<div class="viewcode-block" id="GET_PANDA_EE_FRAME_TRANSFORM_TIMEOUT"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.GET_PANDA_EE_FRAME_TRANSFORM_TIMEOUT">[docs]</a><span class="n">GET_PANDA_EE_FRAME_TRANSFORM_TIMEOUT</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">1</span>  <span class="c1"># Timeout for retrieving the panda EE frame transform.  # noqa: E501</span>
<span class="p">)</span></div>

<span class="c1"># Other script variables.</span>
<div class="viewcode-block" id="AVAILABLE_CONTROL_TYPES"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.AVAILABLE_CONTROL_TYPES">[docs]</a><span class="n">AVAILABLE_CONTROL_TYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;trajectory&quot;</span><span class="p">,</span>
    <span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="s2">&quot;effort&quot;</span><span class="p">,</span>
    <span class="s2">&quot;end_effector&quot;</span><span class="p">,</span>
<span class="p">]</span></div>
<div class="viewcode-block" id="PANDA_JOINTS_FALLBACK"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PANDA_JOINTS_FALLBACK">[docs]</a><span class="n">PANDA_JOINTS_FALLBACK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;arm&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;panda_joint1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint7&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;hand&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;panda_finger_joint1&quot;</span><span class="p">,</span> <span class="s2">&quot;panda_finger_joint2&quot;</span><span class="p">],</span>
<span class="p">}</span>  <span class="c1"># NOTE: Used when the joints can not be determined.</span></div>
<div class="viewcode-block" id="ARM_POSITION_CONTROLLER"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.ARM_POSITION_CONTROLLER">[docs]</a><span class="n">ARM_POSITION_CONTROLLER</span> <span class="o">=</span> <span class="s2">&quot;panda_arm_joint_position_controller&quot;</span></div>
<div class="viewcode-block" id="ARM_EFFORT_CONTROLLER"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.ARM_EFFORT_CONTROLLER">[docs]</a><span class="n">ARM_EFFORT_CONTROLLER</span> <span class="o">=</span> <span class="s2">&quot;panda_arm_joint_effort_controller&quot;</span></div>
<div class="viewcode-block" id="GRASP_FORCE"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.GRASP_FORCE">[docs]</a><span class="n">GRASP_FORCE</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Default panda gripper force. Panda force information: {Continuous force: 70N, max_force: 140 N}.  # noqa: E501</span></div>
<div class="viewcode-block" id="ARM_CONTROL_WAIT_TIMEOUT"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.ARM_CONTROL_WAIT_TIMEOUT">[docs]</a><span class="n">ARM_CONTROL_WAIT_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Default arm control wait timeout [s].</span></div>
<div class="viewcode-block" id="ARM_JOINT_POSITION_WAIT_THRESHOLD"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.ARM_JOINT_POSITION_WAIT_THRESHOLD">[docs]</a><span class="n">ARM_JOINT_POSITION_WAIT_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.07</span>  <span class="c1"># Threshold used for determining whether a joint position is reached (i.e. 0.01 rad per joint).  # noqa: E501</span></div>
<div class="viewcode-block" id="ARM_JOINT_EFFORT_WAIT_THRESHOLD"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.ARM_JOINT_EFFORT_WAIT_THRESHOLD">[docs]</a><span class="n">ARM_JOINT_EFFORT_WAIT_THRESHOLD</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># Threshold used for determining whether a joint position is reached (i.e. 1 N per joint).  # noqa: E501</span></div>
<div class="viewcode-block" id="ARM_JOINT_VELOCITY_WAIT_THRESHOLD"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.ARM_JOINT_VELOCITY_WAIT_THRESHOLD">[docs]</a><span class="n">ARM_JOINT_VELOCITY_WAIT_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.07</span>  <span class="c1"># Threshold used for determining whether the joint velocity is zero (i.e. 1rad/s per joint).  # noqa: E501</span></div>


<div class="viewcode-block" id="PandaEnv"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv">[docs]</a><span class="k">class</span> <span class="nc">PandaEnv</span><span class="p">(</span><span class="n">RobotGazeboGoalEnv</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used for controlling the panda robot and retrieving sensor data.</span>

<span class="sd">    To check any topic we need to have the simulations running, we need to do two</span>
<span class="sd">    things:</span>

<span class="sd">        1. Un-pause the simulation: without that the stream of data doesn&#39;t flow. This</span>
<span class="sd">           is for simulations that are paused for whatever the reason.</span>
<span class="sd">        2. If the simulation was running already for some reason, we need to reset the</span>
<span class="sd">           controllers.</span>

<span class="sd">    This has to do with the fact that some plugins with tf, don&#39;t understand the</span>
<span class="sd">    reset of the simulation and need to be reset to work properly.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        robot_name_space (str): The robot name space.</span>
<span class="sd">        reset_controls (bool): Whether the controllers are reset when the simulation is</span>
<span class="sd">            reset.</span>
<span class="sd">        robot_EE_link (str): The link used for the end effector control.</span>
<span class="sd">        ee_frame_offset (dict): Dictionary containing the used end effector offset.</span>
<span class="sd">        load_gripper (bool): Whether the gripper was loaded.</span>
<span class="sd">        lock_gripper (bool): Whether the gripper should be locked (i.e. not move).</span>
<span class="sd">        joint_states (:obj:`sensor_msgs.msg.JointState`): The current joint states.</span>
<span class="sd">        franka_states (:obj:`franka_msgs.msg.FrankaState`): The current franka states.</span>
<span class="sd">            These give robot specific information about the panda robot.</span>
<span class="sd">        tf_buffer (:obj:`tf2_ros.buffer.Buffer`): Tf buffer object can be used to</span>
<span class="sd">            request transforms.</span>
<span class="sd">        panda_gazebo (:obj:`ros_gazebo_gym.core.LazyImporter`): Lazy importer for the</span>
<span class="sd">            :panda-gazebo:`panda_gazebo &lt;&gt;` package.</span>
<span class="sd">        franka_msgs (:obj:`ros_gazebo_gym.core.LazyImporter`): Lazy importer for the</span>
<span class="sd">            :franka-ros:`franka_msgs &lt;tree/develop/franka_msgs&gt;` package.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot_name_space</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">robot_EE_link</span><span class="o">=</span><span class="s2">&quot;panda_link8&quot;</span><span class="p">,</span>
        <span class="n">ee_frame_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">load_gripper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lock_gripper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">grasping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">control_type</span><span class="o">=</span><span class="s2">&quot;effort&quot;</span><span class="p">,</span>
        <span class="n">reset_robot_pose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">workspace_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">visualize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a new Panda Robot environment.</span>

<span class="sd">        Args:</span>
<span class="sd">            robot_name_space (str, optional): The namespace the robot is on. Defaults to</span>
<span class="sd">                ``&quot;&quot;``.</span>
<span class="sd">            robot_EE_link (str, optional): Robot end effector link name. Defaults to</span>
<span class="sd">                ``panda_link8``.</span>
<span class="sd">            ee_frame_offset (dict, optional): Dictionary containing the end effector</span>
<span class="sd">                offset. Used when retrieving and setting the end effector pose. Defaults</span>
<span class="sd">                to ``None``.</span>
<span class="sd">            load_gripper (bool, optional): Whether we want to load the parallel-jaw</span>
<span class="sd">                gripper. Defaults to ``True``.</span>
<span class="sd">            lock_gripper (bool, optional): Whether we want to lock the parallel-jaw</span>
<span class="sd">                gripper (i.e. not move). Defaults to ``False``.</span>
<span class="sd">            grasping (bool, optional): Whether we want to use the gripper for grasping.</span>
<span class="sd">                If ``True`` and `gripper_max_effort` is unset, applies 10N effort.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            control_Type (str, optional): The type of control you want to use for the</span>
<span class="sd">                panda robot (i.e. hand and arm). Options are: ``trajectory``,</span>
<span class="sd">                ``position``, ``effort`` or ``end_effector``. Defaults to ``effort``.</span>
<span class="sd">            reset_robot_pose (bool, optional): Boolean specifying whether to reset the</span>
<span class="sd">                robot pose when the simulation is reset. Defaults to ``True``.</span>
<span class="sd">            workspace_path (str, optional): The path of the workspace in which the</span>
<span class="sd">                panda_gazebo package should be found. Defaults to ``None``.</span>
<span class="sd">            log_reset (bool, optional): Whether we want to print a log statement when</span>
<span class="sd">                the world/simulation is reset. Defaults to ``True``.</span>
<span class="sd">            visualize (bool, optional): Whether you want to show the RViz visualization.</span>
<span class="sd">                Defaults to ``None`` meaning the task configuration file values will be</span>
<span class="sd">                used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Initialize PandaEnv robot environment...&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize lazy imported modules.</span>
        <span class="c1"># NOTE: Used because if not yet installed these packages will be installed later</span>
        <span class="c1"># and can therefore not be imported at the top of the file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span> <span class="o">=</span> <span class="n">LazyImporter</span><span class="p">(</span><span class="s2">&quot;panda_gazebo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">franka_msgs</span> <span class="o">=</span> <span class="n">LazyImporter</span><span class="p">(</span><span class="s2">&quot;franka_msgs&quot;</span><span class="p">)</span>

        <span class="c1"># Set initial robot env variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span> <span class="o">=</span> <span class="n">robot_name_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_controls</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span> <span class="o">=</span> <span class="n">robot_EE_link</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span> <span class="o">=</span> <span class="n">load_gripper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_gripper</span> <span class="o">=</span> <span class="n">lock_gripper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span> <span class="o">=</span> <span class="n">ee_frame_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ros_shutdown_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span> <span class="o">=</span> <span class="n">CONNECTION_TIMEOUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joint_traj_action_server_default_step_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span> <span class="o">=</span> <span class="n">grasping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_direct_control&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_step_debug_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_log_step_debug_info&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_step_debug_info</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joint_lock_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_controlled_joints_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_set_ee_pose_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_ee_pose_joint_config_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetched_joints</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ros_is_shutdown</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_gripper_goal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__robot_control_type</span> <span class="o">=</span> <span class="n">control_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__in_collision</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__locked_joints</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Thrown control warnings.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;trajectory&quot;</span><span class="p">,</span>
            <span class="s2">&quot;end_effector&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Direct control variable &#39;direct_control&#39; was ignored as it &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is not implemented for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span><span class="si">}</span><span class="s2">&#39; control.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Position control is experimental and not yet fully implemented. &quot;</span>
                <span class="s2">&quot;See https://github.com/rickstaa/panda-gazebo/issues/12.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Wait for the simulation to be started.</span>
        <span class="n">simulation_check_timeout_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_rostime</span><span class="p">()</span> <span class="o">+</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span>
            <span class="n">GAZEBO_SIM_CONNECTION_TIMEOUT</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_rostime</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">simulation_check_timeout_time</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;/gazebo&quot;</span> <span class="ow">in</span> <span class="n">topic</span>
                    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_published_topics</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="p">):</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span><span class="s2">&quot;Waiting for the Gazebo simulation to be started...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since the Panda Gazebo &quot;</span>
                    <span class="s2">&quot;simulation was not started within the set timeout period of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAZEBO_SIM_CONNECTION_TIMEOUT</span><span class="si">}</span><span class="s2"> seconds.&quot;</span>
                <span class="p">)</span>
                <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Validate requested control type.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AVAILABLE_CONTROL_TYPES</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; because control type &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">&#39; that was specified is invalid. Please use one of &quot;</span>
                <span class="s2">&quot;the following robot control types and try again: &quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">ctrl_type</span> <span class="ow">in</span> <span class="n">AVAILABLE_CONTROL_TYPES</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="n">ctrl_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Panda robot is controlled using &#39;</span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">&#39; control.&quot;</span><span class="p">)</span>

        <span class="c1"># Launch the ROS launch that spawns the robot into the world.</span>
        <span class="n">control_type_group</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;trajectory&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;end_effector&quot;</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span>
        <span class="p">)</span>  <span class="c1"># NOTE: Ee control uses the trajectory controllers.</span>
        <span class="n">launch_log_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">get_log_path</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="s2">&quot;put_robot_in_world_launch_</span><span class="si">{}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">_%m_%Y_%H_%M_%S&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_roslaunch_log_to_console&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roslaunch_log_to_console</span>
            <span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">show_rviz</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">visualize</span>
            <span class="k">if</span> <span class="n">visualize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_rviz</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_load_rviz&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ROSLauncher</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">package_name</span><span class="o">=</span><span class="s2">&quot;panda_gazebo&quot;</span><span class="p">,</span>
            <span class="n">launch_file_name</span><span class="o">=</span><span class="s2">&quot;put_robot_in_world.launch&quot;</span><span class="p">,</span>
            <span class="n">workspace_path</span><span class="o">=</span><span class="n">workspace_path</span><span class="p">,</span>
            <span class="n">log_file</span><span class="o">=</span><span class="n">launch_log_file</span><span class="p">,</span>
            <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rviz</span><span class="o">=</span><span class="n">show_rviz</span><span class="p">,</span>
            <span class="n">load_gripper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span><span class="p">,</span>
            <span class="n">disable_franka_gazebo_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rviz_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rviz_file</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_rviz_file&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">end_effector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span><span class="p">,</span>
            <span class="n">max_velocity_scaling_factor</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_velocity_scaling_factor</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_max_velocity_scaling_factor&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">),</span>
            <span class="n">max_acceleration_scaling_factor</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_acceleration_scaling_factor</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_max_acceleration_scaling_factor&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">),</span>
            <span class="n">control_type</span><span class="o">=</span><span class="n">control_type_group</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add ros shutdown hook.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">on_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ros_shutdown_hook</span><span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Initiate gazebo environment ##########</span>
        <span class="c1">########################################</span>
        <span class="c1"># NOTE: In this env we don&#39;t supply the controllers_list but let the</span>
        <span class="c1"># ControllersConnection class determine them based on the running controllers.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PandaEnv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">robot_name_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="p">,</span>
            <span class="n">reset_controls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_controls</span><span class="p">,</span>
            <span class="n">reset_robot_pose</span><span class="o">=</span><span class="n">reset_robot_pose</span><span class="p">,</span>
            <span class="n">reset_world_or_sim</span><span class="o">=</span><span class="s2">&quot;WORLD&quot;</span><span class="p">,</span>
            <span class="n">log_reset</span><span class="o">=</span><span class="n">log_reset</span><span class="p">,</span>
            <span class="n">pause_simulation</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pause_after_step</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pause_after_step&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="p">),</span>
            <span class="n">publish_rviz_training_info_overlay</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_rviz</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_load_rviz&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Initialize sensor topics #############</span>
        <span class="c1">########################################</span>

        <span class="c1"># Create publishers.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Creating publishers.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_collision_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
            <span class="s2">&quot;/ros_gazebo_gym/in_collision&quot;</span><span class="p">,</span> <span class="n">Float32</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">latch</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Create joint state and franka state subscriber.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Connecting to sensors.&quot;</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">JOINT_STATES_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">JointState</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_joint_states_cb</span><span class="p">,</span>
            <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span>
            <span class="n">FRANKA_STATES_TOPIC</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">franka_msgs</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">FrankaState</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_franka_states_cb</span><span class="p">,</span>
            <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create transform listener.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Creating tf2 buffer.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span> <span class="o">=</span> <span class="n">tf2_ros</span><span class="o">.</span><span class="n">Buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tf_listener</span> <span class="o">=</span> <span class="n">tf2_ros</span><span class="o">.</span><span class="n">TransformListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Validate environment arguments #######</span>
        <span class="c1">########################################</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Validating environment arguments.&quot;</span><span class="p">)</span>

        <span class="c1"># Retrieve the robot model from the parameter server.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Retrieving robot model from the parameter server.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">suppress_stderr</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span> <span class="o">=</span> <span class="n">URDF</span><span class="o">.</span><span class="n">from_parameter_server</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;robot_description&quot;</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Failed to retrieve robot model from the parameter server. &quot;</span>
                    <span class="s2">&quot;Please make sure the robot model is loaded on the parameter server &quot;</span>
                    <span class="s2">&quot;and try again.&quot;</span>
                <span class="p">)</span>
                <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># Ensure specified end-effector link exists.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Validating end-effector link.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_link_exists</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The specified end-effector link &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span><span class="si">}</span><span class="s2">&#39; does not &quot;</span>
                <span class="s2">&quot;exist. Please make sure the end-effector link exists and try again.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Retrieve ee frame offset.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Validating end-effector frame offset.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Offset not specified. Using transform between &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;and &#39;panda_EE&#39; as offset.&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">panda_ee_frame_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_pose</span><span class="p">(</span>
                    <span class="n">parent_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span><span class="p">,</span>
                    <span class="n">child_frame</span><span class="o">=</span><span class="s2">&quot;panda_EE&quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">GET_PANDA_EE_FRAME_TRANSFORM_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">panda_ee_frame_offset</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">panda_ee_frame_offset</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">panda_ee_frame_offset</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="s2">&quot;rx&quot;</span><span class="p">:</span> <span class="n">panda_ee_frame_offset</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                    <span class="s2">&quot;ry&quot;</span><span class="p">:</span> <span class="n">panda_ee_frame_offset</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                    <span class="s2">&quot;rz&quot;</span><span class="p">:</span> <span class="n">panda_ee_frame_offset</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="s2">&quot;rw&quot;</span><span class="p">:</span> <span class="n">panda_ee_frame_offset</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Create publishers ####################</span>
        <span class="c1">########################################</span>

        <span class="c1"># Create static transform broadcaster.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Creating static transform broadcaster.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_static_tf_broadcaster</span> <span class="o">=</span> <span class="n">StaticTransformBroadcaster</span><span class="p">()</span>

        <span class="c1"># Publish static transform between the world and the end-effector.</span>
        <span class="c1"># NOTE: Used for RVIZ visualization.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_ee_frame</span><span class="p">()</span>

        <span class="c1">########################################</span>
        <span class="c1"># Connect to control services ##########</span>
        <span class="c1">########################################</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Connecting to robot control services.&quot;</span><span class="p">)</span>

        <span class="c1">################################</span>
        <span class="c1"># Control switcher #############</span>
        <span class="c1">################################</span>
        <span class="c1"># NOTE: Here we use a wrapper around the &#39;control_manager/switch_controller&#39;</span>
        <span class="c1"># provided by the &#39;panda_gazebo&#39; package that knows which controllers to load</span>
        <span class="c1"># for each control type.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Creating to Panda Control switcher.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller_switcher</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">control_switcher</span><span class="o">.</span><span class="n">PandaControlSwitcher</span><span class="p">(</span>
                <span class="n">connection_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span><span class="p">,</span>
                <span class="n">robot_name_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1">################################</span>
        <span class="c1"># Joint Locker #################</span>
        <span class="c1">################################</span>

        <span class="c1"># Connect to the &#39;panda_gazebo&#39; joint lock/unlock service.</span>
        <span class="c1"># NOTE: Used to lock specific panda arm joints.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">joint_lock_srv_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">LOCK_UNLOCK_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span> <span class="o">%</span> <span class="n">joint_lock_srv_topic</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                <span class="n">joint_lock_srv_topic</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_joint_lock_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">joint_lock_srv_topic</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">LockJoints</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">joint_lock_srv_topic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_joint_lock_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Failed to connect to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">joint_lock_srv_topic</span><span class="p">)</span>

        <span class="c1">################################</span>
        <span class="c1"># MoveIt Control services ######</span>
        <span class="c1">################################</span>

        <span class="c1"># Connect to Panda control server &#39;get_controlled_joints&#39; service.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">get_controlled_joints_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">GET_CONTROLLED_JOINTS_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span> <span class="o">%</span> <span class="n">get_controlled_joints_srv_topic</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                <span class="n">get_controlled_joints_srv_topic</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_controlled_joints_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">get_controlled_joints_srv_topic</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">GetControlledJoints</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">get_controlled_joints_srv_topic</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_controlled_joints_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to connect to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">get_controlled_joints_srv_topic</span>
            <span class="p">)</span>

        <span class="c1"># Connect to MoveIt &#39;set_ee_pose&#39; topic.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;end_effector&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">moveit_set_ee_pose_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVEIT_SET_EE_POSE_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                    <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span> <span class="o">%</span> <span class="n">moveit_set_ee_pose_srv_topic</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                    <span class="n">moveit_set_ee_pose_srv_topic</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_set_ee_pose_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                    <span class="n">moveit_set_ee_pose_srv_topic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetEePose</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                    <span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">moveit_set_ee_pose_srv_topic</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_set_ee_pose_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since no connection could be &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;established with the &#39;</span><span class="si">{</span><span class="n">moveit_set_ee_pose_srv_topic</span><span class="si">}</span><span class="s2">&#39; service. &quot;</span>
                    <span class="s2">&quot;This service is needed for controlling the Panda robot using the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span><span class="si">}</span><span class="s2">&#39; control type.&quot;</span>
                <span class="p">)</span>
                <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Connect to MoveIt &#39;get_ee_pose_joint_config&#39; service.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">moveit_get_ee_pose_joint_config_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVEIT_GET_EE_POSE_JOINT_CONFIG_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span>
                <span class="o">%</span> <span class="n">moveit_get_ee_pose_joint_config_srv_topic</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                <span class="n">moveit_get_ee_pose_joint_config_srv_topic</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_ee_pose_joint_config_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">moveit_get_ee_pose_joint_config_srv_topic</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">GetEePoseJointConfig</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">moveit_get_ee_pose_joint_config_srv_topic</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_ee_pose_joint_config_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to connect to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span>
                <span class="o">%</span> <span class="n">moveit_get_ee_pose_joint_config_srv_topic</span>
            <span class="p">)</span>

        <span class="c1">################################</span>
        <span class="c1"># Trajectory action service ####</span>
        <span class="c1">################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;trajectory&quot;</span><span class="p">:</span>
            <span class="c1"># Connect to Joint Trajectory Panda Control (action) service.</span>
            <span class="n">set_joint_trajectory_action_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">SET_JOINT_TRAJECTORY_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; action service.&quot;</span>
                <span class="o">%</span> <span class="n">set_joint_trajectory_action_srv_topic</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">action_server_exists</span><span class="p">(</span>
                <span class="n">set_joint_trajectory_action_srv_topic</span>
            <span class="p">):</span>  <span class="c1"># Check if exists.</span>
                <span class="c1"># Connect to robot control action server.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span>
                    <span class="n">set_joint_trajectory_action_srv_topic</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">FollowJointTrajectoryAction</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Waits until the action server has started up.</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">retval</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client_connected</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Shutdown if not connected.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client_connected</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since no connection could be &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;established with  the &#39;</span><span class="si">{</span><span class="n">set_joint_trajectory_action_srv_topic</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="s2">&quot;service. This service is needed for controlling the Panda robot &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;using the &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span><span class="si">}</span><span class="s2">&#39; control type.&quot;</span>
                <span class="p">)</span>
                <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">################################</span>
        <span class="c1"># Panda control services #######</span>
        <span class="c1">################################</span>

        <span class="c1"># Connect to arm control services/topics.</span>
        <span class="k">if</span> <span class="n">control_type_group</span> <span class="o">!=</span> <span class="s2">&quot;trajectory&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span><span class="p">:</span>  <span class="c1"># Use &#39;panda_gazebo&#39; services.</span>
                <span class="c1"># Connect to Panda Control server &#39;set_joint_commands&#39; service.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">set_joint_commands_srv_topic</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">SET_JOINT_COMMANDS_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                        <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span> <span class="o">%</span> <span class="n">set_joint_commands_srv_topic</span>
                    <span class="p">)</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                        <span class="n">set_joint_commands_srv_topic</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                        <span class="n">set_joint_commands_srv_topic</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointCommands</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                        <span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">set_joint_commands_srv_topic</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since no connection could &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;be established with the &#39;</span><span class="si">{</span><span class="n">set_joint_commands_srv_topic</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                        <span class="s2">&quot;service. This service is needed for controlling the arm in &quot;</span>
                        <span class="s2">&quot;&#39;PROXY&#39; control mode.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Directly publish control commands to controller topics.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span>
                    <span class="c1"># Create arm joint position control publisher.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_position_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/command&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ARM_POSITION_CONTROLLER</span><span class="p">),</span>
                        <span class="n">Float64MultiArray</span><span class="p">,</span>
                        <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Create arm joint effort control publisher.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_effort_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/command&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ARM_EFFORT_CONTROLLER</span><span class="p">),</span>
                        <span class="n">Float64MultiArray</span><span class="p">,</span>
                        <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># Connect to gripper control services.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">control_type_group</span> <span class="o">==</span> <span class="s2">&quot;trajectory&quot;</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">control_type_group</span> <span class="o">!=</span> <span class="s2">&quot;trajectory&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># Connect to &#39;panda_gazebo&#39; gripper control service.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">set_gripper_width_topic</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">SET_GRIPPER_WIDTH_TOPIC</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; service.&quot;</span> <span class="o">%</span> <span class="n">set_gripper_width_topic</span><span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                    <span class="n">set_gripper_width_topic</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                    <span class="n">set_gripper_width_topic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetGripperWidth</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Connected to &#39;</span><span class="si">%s</span><span class="s2">&#39; service!&quot;</span> <span class="o">%</span> <span class="n">set_gripper_width_topic</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span>
                <span class="n">ROSException</span><span class="p">,</span>
                <span class="n">ROSInterruptException</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since no connection could be &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;established with the &#39;</span><span class="si">{</span><span class="n">set_gripper_width_topic</span><span class="si">}</span><span class="s2">&#39; service. This &quot;</span>
                    <span class="s2">&quot;service is needed for controlling the hand in &#39;PROXY&#39; control &quot;</span>
                    <span class="s2">&quot;mode.&quot;</span>
                <span class="p">)</span>
                <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span>
            <span class="ow">and</span> <span class="n">control_type_group</span> <span class="o">!=</span> <span class="s2">&quot;trajectory&quot;</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span>
        <span class="p">):</span>
            <span class="c1"># Connect to &#39;franka_gazebo&#39; gripper command action server.</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; action service.&quot;</span> <span class="o">%</span> <span class="n">FRANKA_GRIPPER_COMMAND_TOPIC</span>
            <span class="p">)</span>
            <span class="n">franka_gripper_action_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">action_server_exists</span><span class="p">(</span><span class="n">FRANKA_GRIPPER_COMMAND_TOPIC</span><span class="p">):</span>
                <span class="c1"># Connect to robot control action server.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span>
                    <span class="n">FRANKA_GRIPPER_COMMAND_TOPIC</span><span class="p">,</span>
                    <span class="n">GripperCommandAction</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Waits until the action server has started up.</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">secs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">retval</span><span class="p">:</span>
                    <span class="n">franka_gripper_action_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">franka_gripper_action_connected</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Shutdown if franka_gripper_action not found.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">franka_gripper_action_connected</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since no connection could be &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;established with the &#39;</span><span class="si">{</span><span class="n">FRANKA_GRIPPER_COMMAND_TOPIC</span><span class="si">}</span><span class="s2">&#39; action &quot;</span>
                    <span class="s2">&quot;service. This service is needed for controlling the hand in &quot;</span>
                    <span class="s2">&quot;&#39;DIRECT&#39; control mode.&quot;</span>
                <span class="p">)</span>
                <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Environment initiation complete message.</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;PandaEnv robot environment initialized.&quot;</span><span class="p">)</span>

    <span class="c1">################################################</span>
    <span class="c1"># Panda Robot env main methods #################</span>
    <span class="c1">################################################</span>
<div class="viewcode-block" id="PandaEnv.get_ee_pose"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.get_ee_pose">[docs]</a>    <span class="k">def</span> <span class="nf">get_ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the current end-effector pose while taking the ``ee_frame_offset``</span>
<span class="sd">        into account. If the offset is zero then it is equal to the</span>
<span class="sd">        :attr:`~PandaEnv.robot_EE_link` pose.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`geometry_msgs.msg.PoseStamped`: The end-effector pose.</span>

<span class="sd">        Raises:</span>
<span class="sd">            :obj:`ros_gazebo_gym.errors.EePoseLookupError`: Error thrown when error</span>
<span class="sd">                occurred while trying to retrieve the EE pose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve EE pose, take offset into account if set.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ee_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_pose</span><span class="p">(</span>
                <span class="n">parent_frame</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">,</span>
                <span class="n">child_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span><span class="p">,</span>
                <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ee_frame_offset</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">LookupException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ConnectivityException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ExtrapolationException</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logwarn_msg</span> <span class="o">=</span> <span class="s2">&quot;End effector pose could not be retrieved as </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">lower_first_char</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;End effector pose could not be retrieved.&quot;</span>
            <span class="k">raise</span> <span class="n">EePoseLookupError</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">logwarn_msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ee_pose</span></div>

<div class="viewcode-block" id="PandaEnv.get_ee_rpy"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.get_ee_rpy">[docs]</a>    <span class="k">def</span> <span class="nf">get_ee_rpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the end effector EE orientation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`panda_gazebo.srv.GetEeRpyResponse`: Object containing the roll (x),</span>
<span class="sd">                yaw (z), pitch (y) euler angles.</span>

<span class="sd">        Raises:</span>
<span class="sd">            :obj:`ros_gazebo_gym.errors.EeRpyLookupError`: Error thrown when error</span>
<span class="sd">                occurred while trying to retrieve the EE rpy rotation using the</span>
<span class="sd">                ``get_ee_pose`` service.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Retrieve the pose of the &#39;EE_frame&#39; in the &#39;world&#39; frame.</span>
            <span class="n">ee_frame_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_pose</span><span class="p">(</span>
                <span class="n">parent_frame</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">,</span>
                <span class="n">child_frame</span><span class="o">=</span><span class="s2">&quot;EE_frame&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Calculate &#39;EE_frame&#39; euler angles.</span>
            <span class="n">gripper_rpy</span> <span class="o">=</span> <span class="n">get_orientation_euler</span><span class="p">(</span><span class="n">ee_frame_pose</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>  <span class="c1"># Yaw, Pitch Roll.</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">LookupException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ConnectivityException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ExtrapolationException</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logwarn_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;End effector orientation (rpy) could not be retrieved as &quot;</span>
                <span class="o">+</span> <span class="n">lower_first_char</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">EeRpyLookupError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;End effector orientation (rpy) could not be retrieved.&quot;</span><span class="p">,</span>
                <span class="n">log_message</span><span class="o">=</span><span class="n">logwarn_msg</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">gripper_rpy</span></div>

<div class="viewcode-block" id="PandaEnv.get_ee_pose_joint_config"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.get_ee_pose_joint_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_ee_pose_joint_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee_pose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a set of possible arm joint configurations for a given end-effector</span>
<span class="sd">        pose.</span>

<span class="sd">        Args:</span>
<span class="sd">            ee_pose (union[:obj:`geometry_msgs.msg.Pose`, list]): A list or pose message</span>
<span class="sd">                containing the end effector position (x, y, z) and orientation</span>
<span class="sd">                (x, y, z, w).</span>

<span class="sd">        Returns:</span>
<span class="sd">            obj:`dict`: Dictionary with joint positions that result in a given EE pose.</span>
<span class="sd">                Empty dictionary is returned if no joint positions could be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># TODO ADD EE_OFFSET!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_ee_pose_joint_config_client_connected</span><span class="p">:</span>
            <span class="n">ee_pose_target</span> <span class="o">=</span> <span class="n">PoseStamped</span><span class="p">(</span>
                <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;rx&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;ry&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;rw&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">normalize_quaternion</span><span class="p">(</span>
                <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span>
            <span class="p">)</span>  <span class="c1"># Make sure the orientation is normalized.</span>

            <span class="c1"># Remove the end-effector offset if set.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_offset_is_zero</span><span class="p">:</span>
                <span class="c1"># FIXME: Is not yet correctly implemented.</span>
                <span class="n">ee_pose_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_ee_offset</span><span class="p">(</span><span class="n">ee_pose_target</span><span class="p">)</span>

            <span class="c1"># Request and return pose.</span>
            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">GetEePoseJointConfigRequest</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span>
            <span class="n">req</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pose_sampling_attempts</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pose_sampling_attempts&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="mi">10</span>
            <span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_get_ee_pose_joint_config_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">joint_configuration_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">joint_names</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">joint_positions</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="n">logdebug_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Joint configuration not retrieved as &quot;</span>
                    <span class="o">+</span> <span class="n">lower_first_char</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="n">logdebug_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">return</span> <span class="n">joint_configuration_dict</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
            <span class="s2">&quot;Joint configuration can not be retrieved as the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name_space</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVEIT_GET_EE_POSE_JOINT_CONFIG_TOPIC</span><span class="si">}</span><span class="s2"> is &quot;</span>
            <span class="s2">&quot;not available.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="PandaEnv.set_ee_pose"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.set_ee_pose">[docs]</a>    <span class="k">def</span> <span class="nf">set_ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee_pose</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the Panda end effector pose.</span>

<span class="sd">        Args:</span>
<span class="sd">            ee_pose (union[:obj:`geometry_msgs.msg.Pose`, list]): A list or pose message</span>
<span class="sd">                containing the end effector position (x, y, z) and orientation</span>
<span class="sd">                (x, y, z, w).</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying if the ee pose was set successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_set_ee_pose_client_connected</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Setting end effector pose failed since the required service &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">MOVEIT_SET_EE_POSE_TOPIC</span><span class="si">}</span><span class="s2">&#39; was not available.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Retrieve action space joints.</span>
        <span class="n">arm_action_space_joints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">item</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># Convert scalar, list, array or tuple to joint dict.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">):</span>
                <span class="n">ee_pose</span> <span class="o">=</span> <span class="p">[</span><span class="n">ee_pose</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">):</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;End effector pose setpoint contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">)</span><span class="si">}</span><span class="s2"> values &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;while it can only contain </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;As a result only the first </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;values are used in the arm and gripper control command.&quot;</span>
                <span class="p">)</span>
            <span class="n">ee_pose</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">,</span> <span class="n">ee_pose</span><span class="p">))</span>

        <span class="c1"># Create set EE pose request message.</span>
        <span class="n">ee_pose_target</span> <span class="o">=</span> <span class="n">PoseStamped</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Fill missing EE pose attributes with current pose values.</span>
            <span class="k">if</span> <span class="n">arm_action_space_joints</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ee_pose</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">cur_ee_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
                <span class="n">cur_ee_pose_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="s2">&quot;rx&quot;</span><span class="p">:</span> <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                    <span class="s2">&quot;ry&quot;</span><span class="p">:</span> <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                    <span class="s2">&quot;rz&quot;</span><span class="p">:</span> <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="s2">&quot;rw&quot;</span><span class="p">:</span> <span class="n">cur_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">cur_ee_pose_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">)</span>
                <span class="n">ee_pose</span> <span class="o">=</span> <span class="n">cur_ee_pose_dict</span>

            <span class="c1"># Populate the ee_pose_target message.</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;rx&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;ry&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">]</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="p">[</span><span class="s2">&quot;rw&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">,</span> <span class="n">PoseStamped</span><span class="p">):</span>
            <span class="n">ee_pose_target</span> <span class="o">=</span> <span class="n">ee_pose</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">,</span> <span class="n">Pose</span><span class="p">):</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">ee_pose</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetEePoseRequest</span><span class="p">):</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">ee_pose</span><span class="o">.</span><span class="n">pose</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If the ee_pose format is not valid.</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Setting end effector pose failed since the ee_pose you specified &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;was given as a &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ee_pose</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; while the &#39;set_ee_pose&#39; &quot;</span>
                <span class="s2">&quot;function only accepts a list, Pose and a PoseStamped.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">normalize_quaternion</span><span class="p">(</span>
            <span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span>
        <span class="p">)</span>

        <span class="c1"># Remove the end-effector offset if set.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_offset_is_zero</span><span class="p">:</span>
            <span class="c1"># FIXME: Is not yet correctly implemented.</span>
            <span class="n">ee_pose_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_ee_offset</span><span class="p">(</span><span class="n">ee_pose_target</span><span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Set EE pose ##########################</span>
        <span class="c1">########################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span>
            <span class="s2">&quot;Setting end effector pose using the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_moveit_set_ee_pose_client</span><span class="o">.</span><span class="n">resolved_name</span><span class="si">}</span><span class="s2">&#39; service.&quot;</span>
        <span class="p">)</span>
        <span class="n">set_ee_pose_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetEePoseRequest</span><span class="p">(</span>
            <span class="n">pose</span><span class="o">=</span><span class="n">ee_pose_target</span><span class="o">.</span><span class="n">pose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveit_set_ee_pose_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">set_ee_pose_req</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">retval</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">logdebug_msg</span> <span class="o">=</span> <span class="n">lower_first_char</span><span class="p">(</span><span class="n">retval</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="n">logdebug_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PandaEnv.set_joint_commands"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.set_joint_commands">[docs]</a>    <span class="k">def</span> <span class="nf">set_joint_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">,</span> <span class="n">arm_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hand_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the Panda arm and hand joint commands based on the set</span>
<span class="sd">        :obj:`~PandaEnv.robot_control_type`.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands (union[:obj:`panda_gazebo.srv.SetJointCommands`, list, dict]):</span>
<span class="sd">                The Panda arm joint positions and gripper width.</span>
<span class="sd">            arm_wait (bool, optional): Wait till the arm control has finished. Defaults</span>
<span class="sd">                to ``False``.</span>
<span class="sd">            hand_wait (bool, optional): Wait till the hand control has finished.</span>
<span class="sd">                Defaults to ``False``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying if the joint commands were set successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="c1"># Set control.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span> <span class="o">==</span> <span class="s2">&quot;effort&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_joint_efforts</span><span class="p">(</span>
                <span class="n">joint_commands</span><span class="p">,</span>
                <span class="n">arm_wait</span><span class="o">=</span><span class="n">arm_wait</span><span class="p">,</span>
                <span class="n">hand_wait</span><span class="o">=</span><span class="n">hand_wait</span><span class="p">,</span>
                <span class="n">direct_control</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_joint_positions</span><span class="p">(</span>
                <span class="n">joint_commands</span><span class="p">,</span>
                <span class="n">arm_wait</span><span class="o">=</span><span class="n">arm_wait</span><span class="p">,</span>
                <span class="n">hand_wait</span><span class="o">=</span><span class="n">hand_wait</span><span class="p">,</span>
                <span class="n">direct_control</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_direct_control</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="PandaEnv.set_joint_positions"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.set_joint_positions">[docs]</a>    <span class="k">def</span> <span class="nf">set_joint_positions</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">,</span> <span class="n">arm_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hand_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">direct_control</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the Panda arm positions and gripper width.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands (union[:obj:`panda_gazebo.srv.SetJointCommands`, list, dict]):</span>
<span class="sd">                The Panda arm joint positions and gripper width.</span>
<span class="sd">            arm_wait (bool, optional): Wait till the arm control has finished. Defaults</span>
<span class="sd">                to ``False``.</span>
<span class="sd">            hand_wait (bool, optional): Wait till the hand control has finished.</span>
<span class="sd">                Defaults to ``False``.</span>
<span class="sd">            direct_control (bool): Whether we want to directly control the panda by</span>
<span class="sd">                publishing to the controller topics or we want to use the</span>
<span class="sd">                ``panda_gazebo`` control proxy. Defaults to ``True``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying if the joint positions were set successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="c1"># Convert float and array joint_commands to dictionary.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span>
            <span class="n">joint_commands</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">):</span>
                <span class="n">joint_commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">joint_commands</span><span class="p">]</span>

            <span class="c1"># Create joint_commands dictionary.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">):</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Joint positions setpoint contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span><span class="si">}</span><span class="s2"> values &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;while it can only contain </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;As a result only the first </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;values are used in the arm and gripper control command.&quot;</span>
                <span class="p">)</span>
            <span class="n">joint_commands</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">))</span>

        <span class="c1"># Throw warning and return if joint_commands is not of the correct type.</span>
        <span class="n">valid_types</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">direct_control</span>
            <span class="k">else</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointCommandsRequest</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">,</span> <span class="n">valid_types</span><span class="p">):</span>
            <span class="n">control_mode</span> <span class="o">=</span> <span class="s2">&quot;DIRECT&quot;</span> <span class="k">if</span> <span class="n">direct_control</span> <span class="k">else</span> <span class="s2">&quot;INDIRECT&quot;</span>
            <span class="n">valid_types_str</span> <span class="o">=</span> <span class="n">list_2_human_text</span><span class="p">(</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">type_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">],</span>
                <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;, a&quot;</span><span class="p">,</span>
                <span class="n">end_separator</span><span class="o">=</span><span class="s2">&quot; or a&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Setting joint positions failed since the &#39;joint_commands&#39; argument is &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;of the &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; type while the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;set_joint_positions&#39; function only accepts a </span><span class="si">{</span><span class="n">valid_types_str</span><span class="si">}</span><span class="s2"> when &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2"> control mode.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">########################################</span>
        <span class="c1"># Set joint positions ##################</span>
        <span class="c1">########################################</span>
        <span class="n">commanded_joints</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">joint_commands</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">joint_commands</span><span class="o">.</span><span class="n">joint_names</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;gripper_max_effort&quot;</span> <span class="ow">in</span> <span class="n">commanded_joints</span>
            <span class="ow">and</span> <span class="s2">&quot;gripper_width&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">commanded_joints</span>
        <span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                <span class="s2">&quot;Gripper max effort was specified but no gripper width was specified. &quot;</span>
                <span class="s2">&quot;As a result the max effort will be ignored.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span>
            <span class="s2">&quot;Setting joint positions using </span><span class="si">{}</span><span class="s2"> control mode.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;DIRECT&quot;</span> <span class="k">if</span> <span class="n">direct_control</span> <span class="k">else</span> <span class="s2">&quot;PROXY&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">direct_control</span><span class="p">:</span>  <span class="c1"># Use proxy service.</span>
            <span class="c1"># Create SetJointCommandsRequest message.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointCommandsRequest</span><span class="p">()</span>
                <span class="n">req</span><span class="o">.</span><span class="n">grasping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span> <span class="k">else</span> <span class="kc">False</span>
                <span class="n">req</span><span class="o">.</span><span class="n">joint_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_commands</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">req</span><span class="o">.</span><span class="n">joint_commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_commands</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">req</span><span class="o">.</span><span class="n">control_type</span> <span class="o">=</span> <span class="s2">&quot;position&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">joint_commands</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointCommandsRequest</span>
            <span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">joint_commands</span>
            <span class="n">req</span><span class="o">.</span><span class="n">arm_wait</span> <span class="o">=</span> <span class="n">arm_wait</span>
            <span class="n">req</span><span class="o">.</span><span class="n">hand_wait</span> <span class="o">=</span> <span class="n">hand_wait</span>

            <span class="c1"># Ensure that the gripper is blocked if self.lock_gripper is True.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_gripper</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_gripper_commands</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

            <span class="c1"># Prevent duplicate gripper commands from being sent.</span>
            <span class="k">if</span> <span class="n">is_sublist</span><span class="p">([</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">],</span> <span class="n">req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_gripper_goal</span> <span class="o">!=</span> <span class="n">req</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_gripper_goal</span> <span class="o">=</span> <span class="n">req</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="n">remove_gripper_commands_from_joint_commands_msg</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

            <span class="c1"># Send arm and hand control commands.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_client_connected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;Setting joints positions failed since the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">SET_JOINT_COMMANDS_TOPIC</span><span class="si">}</span><span class="s2">&#39; service was not available.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Directly control the controllers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_joint_positions_direct_control</span><span class="p">(</span>
                <span class="n">joint_commands</span><span class="p">,</span> <span class="n">arm_wait</span><span class="o">=</span><span class="n">arm_wait</span><span class="p">,</span> <span class="n">hand_wait</span><span class="o">=</span><span class="n">hand_wait</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_joint_positions_direct_control</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">,</span> <span class="n">arm_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hand_wait</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Directly publish position commands to the controller command topics. This</span>
<span class="sd">        is faster but does not wait for the control command to complete.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands (dict): The panda joint positions and gripper width.</span>
<span class="sd">            arm_wait (bool, optional): Wait till the arm control has finished. Defaults</span>
<span class="sd">                to ``False``.</span>
<span class="sd">            hand_wait (bool, optional): Wait till the hand control has finished.</span>
<span class="sd">                Defaults to ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve arm and gripper commands.</span>
        <span class="n">arm_commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arm_commands</span><span class="p">(</span>
            <span class="n">joint_commands</span><span class="p">,</span> <span class="n">control_type</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">fill_missing</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">gripper_width</span><span class="p">,</span> <span class="n">gripper_max_effort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gripper_commands</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span>

        <span class="c1"># Send arm and hand control commands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_position_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="n">Float64MultiArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">arm_commands</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">arm_wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_till_arm_control_done</span><span class="p">(</span>
                <span class="n">control_type</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
                <span class="n">joint_setpoint</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">arm_commands</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_gripper</span> <span class="ow">and</span> <span class="n">gripper_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">GripperCommandGoal</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">gripper_width</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>  <span class="c1"># NOTE: Done the action expects the finger width.</span>
            <span class="n">req</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">max_effort</span> <span class="o">=</span> <span class="n">gripper_max_effort</span>

            <span class="c1"># Send gripper goal if it was different from the previous one.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_gripper_goal</span> <span class="o">!=</span> <span class="n">req</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_gripper_goal</span> <span class="o">=</span> <span class="n">req</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hand_wait</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">(</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">secs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="PandaEnv.set_joint_efforts"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.set_joint_efforts">[docs]</a>    <span class="k">def</span> <span class="nf">set_joint_efforts</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">,</span> <span class="n">arm_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hand_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">direct_control</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the Panda arm efforts and the gripper width.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands (union[:obj:`panda_gazebo.srv.SetJointCommandsRequest`, list, dict]):</span>
<span class="sd">                The panda joint efforts and gripper width.</span>
<span class="sd">            direct_control (bool): Whether we want to directly control the panda by</span>
<span class="sd">                publishing to the controller topics or we want to use the</span>
<span class="sd">                ``panda_gazebo`` control proxy. Defaults to ``True``.</span>
<span class="sd">            arm_wait (bool, optional): Wait till the arm control has finished. Defaults</span>
<span class="sd">                to ``False``.</span>
<span class="sd">            hand_wait (bool, optional): Wait till the hand control has finished.</span>
<span class="sd">                Defaults to ``False``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying if the joint efforts were set successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="c1"># Convert float and array joint_commands to dictionary.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span>
            <span class="n">joint_commands</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">):</span>
                <span class="n">joint_commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">joint_commands</span><span class="p">]</span>

            <span class="c1"># Create joint_commands dictionary.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">):</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Joint efforts setpoint contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span><span class="si">}</span><span class="s2"> values &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;while it can only contain </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;As a result only the first </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;values are used in the arm and gripper control command.&quot;</span>
                <span class="p">)</span>
            <span class="n">joint_commands</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">))</span>

        <span class="c1"># Throw warning and return if joint_commands is not of the correct type.</span>
        <span class="n">valid_types</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">direct_control</span>
            <span class="k">else</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointCommandsRequest</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">,</span> <span class="n">valid_types</span><span class="p">):</span>
            <span class="n">control_mode</span> <span class="o">=</span> <span class="s2">&quot;DIRECT&quot;</span> <span class="k">if</span> <span class="n">direct_control</span> <span class="k">else</span> <span class="s2">&quot;INDIRECT&quot;</span>
            <span class="n">valid_types_str</span> <span class="o">=</span> <span class="n">list_2_human_text</span><span class="p">(</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">type_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">],</span>
                <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;, a&quot;</span><span class="p">,</span>
                <span class="n">end_separator</span><span class="o">=</span><span class="s2">&quot; or a&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Setting joint efforts failed since the &#39;joint_commands&#39; argument is &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;of the &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; type while the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;set_joint_efforts&#39; function only accepts a </span><span class="si">{</span><span class="n">valid_types_str</span><span class="si">}</span><span class="s2"> when &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2"> control mode.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">########################################</span>
        <span class="c1"># Set joint efforts ####################</span>
        <span class="c1">########################################</span>
        <span class="n">commanded_joints</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">joint_commands</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">joint_commands</span><span class="o">.</span><span class="n">joint_names</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;gripper_max_effort&quot;</span> <span class="ow">in</span> <span class="n">commanded_joints</span>
            <span class="ow">and</span> <span class="s2">&quot;gripper_width&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">commanded_joints</span>
        <span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                <span class="s2">&quot;Gripper max effort was specified but no gripper width was specified. &quot;</span>
                <span class="s2">&quot;As a result the max effort will be ignored.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span>
            <span class="s2">&quot;Setting joint efforts using </span><span class="si">{}</span><span class="s2"> control mode.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;DIRECT&quot;</span> <span class="k">if</span> <span class="n">direct_control</span> <span class="k">else</span> <span class="s2">&quot;PROXY&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">direct_control</span><span class="p">:</span>  <span class="c1"># Use proxy service.</span>
            <span class="c1"># Create SetJointCommandsRequest message.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointCommandsRequest</span><span class="p">()</span>
                <span class="n">req</span><span class="o">.</span><span class="n">grasping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span> <span class="k">else</span> <span class="kc">False</span>
                <span class="n">req</span><span class="o">.</span><span class="n">joint_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_commands</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">req</span><span class="o">.</span><span class="n">joint_commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_commands</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">req</span><span class="o">.</span><span class="n">control_type</span> <span class="o">=</span> <span class="s2">&quot;effort&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">joint_commands</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetJointCommandsRequest</span>
            <span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">joint_commands</span>
            <span class="n">req</span><span class="o">.</span><span class="n">arm_wait</span> <span class="o">=</span> <span class="n">arm_wait</span>
            <span class="n">req</span><span class="o">.</span><span class="n">hand_wait</span> <span class="o">=</span> <span class="n">hand_wait</span>

            <span class="c1"># Ensure that the gripper is blocked if self.lock_gripper is True.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_gripper</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_gripper_commands</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

            <span class="c1"># Send arm and hand control commands.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_client_connected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;Setting joints efforts failed since the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">SET_JOINT_COMMANDS_TOPIC</span><span class="si">}</span><span class="s2">&#39; service was not available.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Directly control the controllers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_joint_efforts_direct_control</span><span class="p">(</span>
                <span class="n">joint_commands</span><span class="p">,</span> <span class="n">arm_wait</span><span class="o">=</span><span class="n">arm_wait</span><span class="p">,</span> <span class="n">hand_wait</span><span class="o">=</span><span class="n">hand_wait</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_joint_efforts_direct_control</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">joint_commands</span><span class="p">,</span>
        <span class="n">arm_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Currently not used.</span>
        <span class="n">hand_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Directly publish effort commands to the controller command topics. This is</span>
<span class="sd">        faster but does not wait for the control command to complete.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands (dict): The panda joint efforts and gripper width.</span>
<span class="sd">            hand_wait (bool, optional): Wait till the hand control has finished.</span>
<span class="sd">                Defaults to ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve arm and gripper commands.</span>
        <span class="n">arm_commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arm_commands</span><span class="p">(</span>
            <span class="n">joint_commands</span><span class="p">,</span> <span class="n">control_type</span><span class="o">=</span><span class="s2">&quot;effort&quot;</span><span class="p">,</span> <span class="n">fill_missing</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">gripper_width</span><span class="p">,</span> <span class="n">gripper_max_effort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gripper_commands</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span>

        <span class="c1"># Send arm and hand control commands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_effort_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="n">Float64MultiArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">arm_commands</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="p">)</span>
        <span class="c1"># NOTE: We currently do not have to wait for control efforts to be applied</span>
        <span class="c1"># since the &#39;FrankaHWSim&#39; does not yet implement control latency. Torques</span>
        <span class="c1"># are therefore applied instantly.</span>
        <span class="c1"># if arm_wait:</span>
        <span class="c1">#     self._wait_till_arm_control_done(</span>
        <span class="c1">#         control_type=&quot;effort&quot;,</span>
        <span class="c1">#         joint_setpoint=list(arm_commands.values())</span>
        <span class="c1">#     )</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_gripper</span> <span class="ow">and</span> <span class="n">gripper_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">GripperCommandGoal</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">gripper_width</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>  <span class="c1"># NOTE: Done the action expects the finger width.</span>
            <span class="n">req</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">max_effort</span> <span class="o">=</span> <span class="n">gripper_max_effort</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hand_wait</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">secs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="p">)</span>

<div class="viewcode-block" id="PandaEnv.set_arm_joint_trajectory"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.set_arm_joint_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">set_arm_joint_trajectory</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">joint_trajectory</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">time_from_start</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the panda arm joint trajectory.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_trajectory (union[:obj:`panda_gazebo.msg.FollowJointTrajectoryActionGoal`, np.array, list, dict])</span>
<span class="sd">                The joint trajectory you want to set.</span>
<span class="sd">            wait  (bool, optional): Wait till the control has finished. Defaults to</span>
<span class="sd">                ``False``.</span>
<span class="sd">            time_from_start (float): At what time a trajectory point</span>
<span class="sd">                should be reach in seconds. Only used when a single trajectory point is</span>
<span class="sd">                given (i.e. list, dict)</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying if the joint trajectory was set successfully.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the input trajectory is invalid.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If you input a ``tuple``, ``list``, ``int`` or ``float`` a joint trajectory</span>
<span class="sd">            message will be constructed with one waypoint point. To set multiple</span>
<span class="sd">            waypoints, you must supply a 2D numpy array or a dictionary containing an</span>
<span class="sd">            equal number of joint commands for each joint, one for each waypoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client_connected</span><span class="p">:</span>
            <span class="n">arm_action_space_joints</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_space_joints</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="c1"># Convert float and array joint_trajectory to dictionary.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="n">joint_trajectory</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">):</span>
                    <span class="n">joint_trajectory</span> <span class="o">=</span> <span class="p">[</span><span class="n">joint_trajectory</span><span class="p">]</span>

                <span class="c1"># Create joint trajectory dictionary.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">):</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Joint trajectory contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">)</span><span class="si">}</span><span class="s2"> values &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;while it can only contain </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;As a result only the first </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;values are used in the arm and gripper control command.&quot;</span>
                    <span class="p">)</span>
                <span class="n">joint_trajectory</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">,</span> <span class="n">joint_trajectory</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
                <span class="ow">and</span> <span class="n">joint_trajectory</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">joint_trajectory</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">):</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Joint trajectory contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">)</span><span class="si">}</span><span class="s2"> values &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;while it can only contain </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;As a result only the first </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;values are used in the arm and gripper control command.&quot;</span>
                    <span class="p">)</span>
                <span class="n">joint_trajectory</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">arm_action_space_joints</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="n">joint_trajectory</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The joint trajectory could not be set since the &quot;</span>
                    <span class="s2">&quot;&#39;joint_trajectory&#39; you supplied is invalid. If you want to send &quot;</span>
                    <span class="s2">&quot;multiple waypoints the &#39;joint_trajectory&#39; should be a 2D array or &quot;</span>
                    <span class="s2">&quot;a dictionary containing an equal number of joint commands for &quot;</span>
                    <span class="s2">&quot;each joint, one for each waypoint.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Create SetJointtrajectory message.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">time_from_start</span> <span class="o">=</span> <span class="n">time_from_start</span> <span class="k">if</span> <span class="n">time_from_start</span> <span class="k">else</span> <span class="mf">0.01</span>
                <span class="n">time_axis_step</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">time_from_start</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">time_from_start</span>
                <span class="p">)</span>
                <span class="n">req</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">action_dict_2_joint_trajectory_msg</span><span class="p">(</span>
                        <span class="n">joint_trajectory</span><span class="p">,</span> <span class="n">time_axis_step</span><span class="o">=</span><span class="n">time_axis_step</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">joint_trajectory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">FollowJointTrajectoryGoal</span>
            <span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">joint_trajectory</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;Setting joint trajectory failed since the &#39;joint_trajectory&#39; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;input argument is of the &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">joint_trajectory</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; type while &quot;</span>
                    <span class="s2">&quot;the &#39;set_arm_joint_trajectory&#39; function only accepts a dictionary, &quot;</span>
                    <span class="s2">&quot;list or a FollowJointTrajectoryActionGoal message.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1">########################################</span>
            <span class="c1"># Set trajectory #######################</span>
            <span class="c1">########################################</span>
            <span class="c1"># Try to setting joint trajectory if service is available.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span>
                <span class="s2">&quot;Setting joint trajectory using the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client</span><span class="o">.</span><span class="n">action_client</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2">&#39; action &quot;</span>
                <span class="s2">&quot;service.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_control_client</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">retval</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Setting joint trajectory failed.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
            <span class="s2">&quot;Setting joints trajectory failed since the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">SET_JOINT_TRAJECTORY_TOPIC</span><span class="si">}</span><span class="s2">&#39; service was not available.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PandaEnv.set_gripper_width"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.set_gripper_width">[docs]</a>    <span class="k">def</span> <span class="nf">set_gripper_width</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gripper_width</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grasping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_effort</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the Panda gripper width.</span>

<span class="sd">        Args:</span>
<span class="sd">            gripper_width (float): The desired gripper width.</span>
<span class="sd">            wait (bool, optional): Wait till the gripper control has finished. Defaults</span>
<span class="sd">                to ``False``.</span>
<span class="sd">            grasp (bool): Whether we want to grasp a object. Defaults to ``False``. Can</span>
<span class="sd">                be overwritten by setting the ``&lt;NS&gt;/control/grasping`` ROS parameter.</span>
<span class="sd">            max_effort (float, optional): The max effort used when grasping. Defaults to</span>
<span class="sd">                ``None``. Meaning the action service default is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying if the gripper width was set successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_client_connected</span><span class="p">:</span>
            <span class="n">grasping</span> <span class="o">=</span> <span class="n">grasping</span> <span class="k">if</span> <span class="n">grasping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_debug_logger</span><span class="p">(</span>
                <span class="s2">&quot;Setting gripper width using the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_client</span><span class="o">.</span><span class="n">resolved_name</span><span class="si">}</span><span class="s2">&#39; service.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Create gripper width request.</span>
            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">SetGripperWidthRequest</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">gripper_width</span>
            <span class="k">if</span> <span class="n">grasping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">grasping</span> <span class="o">=</span> <span class="n">grasping</span>
            <span class="k">if</span> <span class="n">max_effort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">max_effort</span> <span class="o">=</span> <span class="n">max_effort</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>  <span class="c1"># Done since it will otherwise use the msg default value.</span>
                <span class="n">req</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">wait</span>

            <span class="c1"># Send gripper width request.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Setting gripper_width failed since the &#39;</span><span class="si">{</span><span class="n">SET_JOINT_COMMANDS_TOPIC</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
            <span class="s2">&quot;service was not available.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_wait_till_arm_control_done</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">control_type</span><span class="p">,</span>
        <span class="n">joint_setpoint</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">check_gradient</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait till arm control is finished. Meaning the robot state is within range</span>
<span class="sd">        of the joint position and joint effort setpoints (or the velocity is zero).</span>

<span class="sd">        Args:</span>
<span class="sd">            control_type (str): The type of control that is being executed and on which</span>
<span class="sd">                we should wait. Options are ``effort`` and ``position``.</span>
<span class="sd">            joint_setpoint (list): The setpoint to wait for.</span>
<span class="sd">            timeout (int, optional): The timeout when waiting for the control</span>
<span class="sd">                to be done. Defaults to</span>
<span class="sd">                :attr:`~PandaControlServer._wait_till_arm_control_done_timeout`.</span>
<span class="sd">            check_gradient (boolean, optional): If enabled the script will also return</span>
<span class="sd">                when the gradients become zero. Defaults to ``True``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            :obj:`ValueError`: Raised when the control_type is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">control_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Please specify a valid control type. Valid values are &#39;position&#39; &amp; &quot;</span>
                <span class="s2">&quot;&#39;effort&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">control_type</span> <span class="o">=</span> <span class="n">control_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">ARM_CONTROL_WAIT_TIMEOUT</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Compute the state masks.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">arm_states_mask</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Not waiting for control to be completed as no information could &quot;</span>
                <span class="s2">&quot;be retrieved about which joints are controlled when using &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;control. Please make sure the &#39;</span><span class="si">%s</span><span class="s2">&#39; controller that is needed for &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;control are initialized.&quot;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">control_type</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">ARM_POSITION_CONTROLLER</span>
                        <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                        <span class="k">else</span> <span class="n">ARM_EFFORT_CONTROLLER</span>
                    <span class="p">),</span>
                    <span class="n">control_type</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">arm_states_mask</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Not waiting for control to be completed as no joints appear to be &quot;</span>
                <span class="s2">&quot;controlled when using &#39;</span><span class="si">%s</span><span class="s2">&#39; control. Please make sure the &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;controller that is needed for &#39;</span><span class="si">%s</span><span class="s2">&#39; control are initialized.&quot;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">control_type</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">ARM_POSITION_CONTROLLER</span>
                        <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                        <span class="k">else</span> <span class="n">ARM_EFFORT_CONTROLLER</span>
                    <span class="p">),</span>
                    <span class="n">control_type</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Wait till robot positions/efforts reach the setpoint or the velocities are</span>
        <span class="c1"># not changing anymore.</span>
        <span class="n">timeout_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_rostime</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()</span> <span class="ow">and</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_rostime</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">timeout_time</span><span class="p">:</span>
            <span class="c1"># Wait till joint positions/efforts are within range or vel not changing.</span>
            <span class="n">joint_states</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">arm_states_mask</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">effort</span><span class="p">,</span> <span class="n">arm_states_mask</span><span class="p">)))</span>
            <span class="p">)</span>
            <span class="n">state_threshold</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ARM_JOINT_POSITION_WAIT_THRESHOLD</span>
                <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                <span class="k">else</span> <span class="n">ARM_JOINT_EFFORT_WAIT_THRESHOLD</span>
            <span class="p">)</span>
            <span class="n">grad_threshold</span> <span class="o">=</span> <span class="n">ARM_JOINT_VELOCITY_WAIT_THRESHOLD</span>
            <span class="n">joint_setpoint_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">joint_setpoint</span><span class="p">),</span>
                <span class="n">joint_states</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_setpoint</span><span class="p">)</span> <span class="p">:],</span>  <span class="c1"># noqa: E203, E501</span>
            <span class="p">)</span>

            <span class="c1"># Add current state to state_buffer and delete oldest entry.</span>
            <span class="n">state_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_states</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">grad_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_states</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">state_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_buffer</span><span class="p">,</span> <span class="p">[</span><span class="n">joint_states</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">grad_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">state_buffer</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Check if setpoint is reached.</span>
            <span class="k">if</span> <span class="n">check_gradient</span><span class="p">:</span>  <span class="c1"># Check position/effort and gradients.</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">joint_states</span> <span class="o">-</span> <span class="n">joint_setpoint_tmp</span><span class="p">)</span>
                    <span class="o">&lt;=</span> <span class="n">state_threshold</span>  <span class="c1"># Check if difference norm is within threshold.</span>
                <span class="p">)</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">grad_threshold</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">grad_buffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">]</span>  <span class="c1"># Check if all velocities are close to zero.</span>
                <span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Only check position/effort.</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">joint_states</span> <span class="o">-</span> <span class="n">joint_setpoint_tmp</span><span class="p">)</span>
                    <span class="o">&lt;=</span> <span class="n">state_threshold</span>  <span class="c1"># Check if difference norm is within threshold.</span>
                <span class="p">):</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="PandaEnv.lock_joints"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.lock_joints">[docs]</a>    <span class="k">def</span> <span class="nf">lock_joints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Locks specific panda joints.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_names (list): The names of the joints to lock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joint_lock_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">LockJointsRequest</span><span class="p">(</span><span class="n">joint_names</span><span class="o">=</span><span class="n">joint_names</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__locked_joints</span> <span class="o">=</span> <span class="n">joint_names</span> <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="k">else</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="PandaEnv.unlock_joints"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.unlock_joints">[docs]</a>    <span class="k">def</span> <span class="nf">unlock_joints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unlocks specific panda joints.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_names (list): The names of the joints to unlock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joint_lock_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">LockJointsRequest</span><span class="p">(</span><span class="n">joint_names</span><span class="o">=</span><span class="n">joint_names</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__locked_joints</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="k">else</span> <span class="n">joint_names</span></div>

    <span class="c1">################################################</span>
    <span class="c1"># Panda Robot env helper methods ###############</span>
    <span class="c1">################################################</span>
    <span class="k">def</span> <span class="nf">_joint_states_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Joint states subscriber callback function.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (:obj:`sensor_msgs.msg.JointState`): The data that is returned by the</span>
<span class="sd">                subscriber.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_franka_states_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Franka states subscriber callback function.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (:obj:`franka_msgs.msg.FrankaState`): The data that is returned by the</span>
<span class="sd">                subscriber.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">franka_states</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__in_collision</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">franka_states</span><span class="o">.</span><span class="n">cartesian_contact</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ros_shutdown_requested</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_collision_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">Float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_PandaEnv__in_collision</span><span class="p">))</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_all_sensors_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks whether we are receiving sensor data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_joint_states_ready</span><span class="p">()</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;ALL SENSORS READY&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_joint_states_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if we are receiving joint state sensor data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`sensor_msgs.msgs.JointState`: Array containing the joint states.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_message</span><span class="p">(</span>
                    <span class="n">JOINT_STATES_TOPIC</span><span class="p">,</span> <span class="n">JointState</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_timeout</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Current &#39;</span><span class="si">{</span><span class="n">JOINT_STATES_TOPIC</span><span class="si">}</span><span class="s2">&#39; READY=&gt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">ROSException</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Current &#39;</span><span class="si">{</span><span class="n">JOINT_STATES_TOPIC</span><span class="si">}</span><span class="s2">&#39; not ready yet, retrying for &quot;</span>
                    <span class="s2">&quot;getting joint_states.&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span>

    <span class="k">def</span> <span class="nf">_step_debug_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Small wrapper method around the :obj:`rospy.logdebug` method that blocks</span>
<span class="sd">        logging when the :obj:`~PandaReachEnv._log_step_debug_info` parameter is</span>
<span class="sd">        ``False``.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Done to increase the step frequency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_step_debug_info</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_ros_shutdown_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called when the ROS node is shutdown.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ros_shutdown_requested</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_fill_missing_arm_joint_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">,</span> <span class="n">control_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fills missing arm joint commands with the current joint states if the joint</span>
<span class="sd">        states dictionary is incomplete.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands (dict): The joint commands dictionary.</span>
<span class="sd">            control_type (str): The type of control commands that are being executed.</span>
<span class="sd">                Options are ``effort`` and ``position``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The arm joint commands dictionary with the missing joint states</span>
<span class="sd">                filled in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cur_joint_commands</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arm_positions</span>
            <span class="k">if</span> <span class="n">control_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_efforts</span>
        <span class="p">)</span>
        <span class="n">cur_joint_commands</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span>
        <span class="n">joint_commands</span> <span class="o">=</span> <span class="n">cur_joint_commands</span>
        <span class="k">return</span> <span class="n">joint_commands</span>

    <span class="k">def</span> <span class="nf">_get_arm_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">,</span> <span class="n">control_type</span><span class="p">,</span> <span class="n">fill_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the arm commands from the joint commands dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands (dict): The joint commands dictionary.</span>
<span class="sd">            control_type (str): The type of control commands that are being executed.</span>
<span class="sd">                Options are ``effort`` and ``position``.</span>
<span class="sd">            fill_missing (bool, optional): Whether to fill missing arm joint commands</span>
<span class="sd">                with the current joint states if the joint states dictionary is</span>
<span class="sd">                incomplete. Defaults to ``False``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The arm joint commands dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove gripper commands.</span>
        <span class="n">arm_commands</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">joint_commands</span><span class="p">)</span>
        <span class="n">arm_commands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">arm_commands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Fill missing arm joint commands if needed.</span>
        <span class="k">if</span> <span class="n">fill_missing</span><span class="p">:</span>
            <span class="n">arm_commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_missing_arm_joint_commands</span><span class="p">(</span>
                <span class="n">arm_commands</span><span class="p">,</span> <span class="n">control_type</span><span class="o">=</span><span class="n">control_type</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">arm_commands</span>

    <span class="k">def</span> <span class="nf">_get_gripper_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the gripper commands from the joint commands dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands (dict): The joint commands dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - **gripper_width** (float): The gripper width.</span>
<span class="sd">                - **gripper_max_effort** (float): The gripper max effort.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gripper_width</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gripper_max_effort</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_gripper</span><span class="p">:</span>
            <span class="c1"># Block gripper if requested and set max effort to 10N if grasping.</span>
            <span class="n">gripper_width</span> <span class="o">=</span> <span class="n">joint_commands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">gripper_max_effort</span> <span class="o">=</span> <span class="n">joint_commands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">,</span> <span class="n">GRASP_FORCE</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grasping</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">gripper_width</span><span class="p">,</span> <span class="n">gripper_max_effort</span>

    <span class="k">def</span> <span class="nf">_block_gripper_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands_msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modifies the joint commands message to block the gripper commands.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands_msg (:obj:`panda_gazebo.msg.JointCommands`): The joint</span>
<span class="sd">                commands message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span><span class="p">:</span>
            <span class="n">joint_commands_msg</span><span class="o">.</span><span class="n">grasping</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">joint_commands_msg</span> <span class="o">=</span> <span class="n">remove_gripper_commands_from_joint_commands_msg</span><span class="p">(</span>
                <span class="n">joint_commands_msg</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">joint_commands_msg</span>

    <span class="k">def</span> <span class="nf">_add_ee_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds the end-effector frame to the TF tree.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Created based on the end effector link and the offset specified in the</span>
<span class="sd">            configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ee_frame_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_frame_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_static_tf_broadcaster</span><span class="o">.</span><span class="n">sendTransform</span><span class="p">(</span>
            <span class="n">TransformStamped</span><span class="p">(</span>
                <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
                <span class="n">child_frame_id</span><span class="o">=</span><span class="s2">&quot;EE_frame&quot;</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">Transform</span><span class="p">(</span>
                    <span class="n">translation</span><span class="o">=</span><span class="n">ee_frame_offset</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                    <span class="n">rotation</span><span class="o">=</span><span class="n">normalize_quaternion</span><span class="p">(</span><span class="n">ee_frame_offset</span><span class="o">.</span><span class="n">orientation</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_frame_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">child_frame</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the pose of the child frame relative to the parent frame.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent_frame (str): The parent frame.</span>
<span class="sd">            child_frame (str): The child frame.</span>
<span class="sd">            offset (:obj:`geometry_msgs.msg.Pose`, optional): The offset of the child</span>
<span class="sd">                frame relative to the parent frame. Defaults to ``None`` meaning no</span>
<span class="sd">                offset is applied.</span>
<span class="sd">            timeout (float, optional): The timeout in seconds. Defaults to 1.0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`geometry_msgs.msg.StampedPose`: The stamped pose of the child frame</span>
<span class="sd">                relative to the parent frame.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TimeoutError: Raised when the timeout is exceeded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset_pose</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">offset</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">Pose</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">orientation</span><span class="o">=</span><span class="n">Quaternion</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># Retrieve transform between child and the parent frame.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># NOTE: Used instead of &#39;lookup_transform&#39; to prevent flipped Quaternion.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="n">PoseStamped</span><span class="p">(</span>
                    <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="n">child_frame</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
                    <span class="n">pose</span><span class="o">=</span><span class="n">offset_pose</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">parent_frame</span><span class="p">,</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">LookupException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ConnectivityException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ExtrapolationException</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not retrieve (stamped) pose of the &#39;</span><span class="si">{</span><span class="n">child_frame</span><span class="si">}</span><span class="s2">&#39; relative &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;to the &#39;</span><span class="si">{</span><span class="n">parent_frame</span><span class="si">}</span><span class="s2">&#39; frame. Please check that these frames are &quot;</span>
                <span class="s2">&quot;available in the tf tree.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_ee_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee_pose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove end-effector offset from end-effector pose.</span>

<span class="sd">        Args:</span>
<span class="sd">            ee_pose (:obj:`geometry_msgs.msg.PoseStamped`): The end-effector pose.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`geometry_msgs.msg.PoseStamped`: The end-effector pose adjusted for</span>
<span class="sd">                the end-effector offset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_frame_offset_stamped</span>

        <span class="c1"># Transform ee_pose to end-effector frame.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transformed_ee_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="n">ee_pose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span><span class="p">,</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">LookupException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ConnectivityException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ExtrapolationException</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Failed to transform the end-effector pose to the end-effector frame.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="c1"># Remove position offset from ee_pose.</span>
        <span class="c1"># FIXME: This approach is naive and does not take into account whether the</span>
        <span class="c1"># orientation is flipped.</span>
        <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">-=</span> <span class="n">offset_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
        <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">-=</span> <span class="n">offset_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
        <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">-=</span> <span class="n">offset_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span>

        <span class="c1"># Remove orientation offset from ee_pose.</span>
        <span class="n">inv_offset_orientation</span> <span class="o">=</span> <span class="n">quaternion_inverse</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">offset_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">offset_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">offset_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                <span class="n">offset_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ee_pose_orientation</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
            <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">ee_pose_orientation</span> <span class="o">=</span> <span class="n">quaternion_multiply</span><span class="p">(</span>
            <span class="n">ee_pose_orientation</span><span class="p">,</span> <span class="n">inv_offset_orientation</span>
        <span class="p">)</span>
        <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ee_pose_orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ee_pose_orientation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ee_pose_orientation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">transformed_ee_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ee_pose_orientation</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Transform the pose back to the world frame</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">final_ee_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="n">transformed_ee_pose</span><span class="p">,</span> <span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">LookupException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ConnectivityException</span><span class="p">,</span>
            <span class="n">tf2_ros</span><span class="o">.</span><span class="n">ExtrapolationException</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Failed to transform the offset adjusted end-effector pose back to &quot;</span>
                <span class="s2">&quot;the world frame.&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s2">&quot;Transform failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">final_ee_pose</span>

    <span class="c1">#############################################</span>
    <span class="c1"># Retrieve robot states #####################</span>
    <span class="c1">#############################################</span>
    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.joints"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.joints">[docs]</a>    <span class="k">def</span> <span class="nf">joints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the joints that can be controlled when using the current Panda arm</span>
<span class="sd">        and hand control types.</span>

<span class="sd">        .. important::</span>
<span class="sd">            For performance reasons the controlled joints are currently fetched at the</span>
<span class="sd">            first call. Please call the :meth:`~PandaEnv.refresh_joints` method to</span>
<span class="sd">            re-fetch the currently controlled joints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_controlled_joints_client_connected</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_controlled_joints_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">panda_gazebo</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">GetControlledJointsRequest</span><span class="p">(</span>
                        <span class="n">control_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_control_type</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">controlled_joints_arm</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">controlled_joints_arm</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">PANDA_JOINTS_FALLBACK</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">controlled_joints_hand</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_gripper</span>
                        <span class="ow">or</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span>
                        <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">controlled_joints_hand</span>
                    <span class="p">)</span>
                    <span class="k">else</span> <span class="n">PANDA_JOINTS_FALLBACK</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">flatten_list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="n">flatten_list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]])</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                    <span class="s2">&quot;Retrieving controlled joints failed since the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">GET_CONTROLLED_JOINTS_TOPIC</span><span class="si">}</span><span class="s2">&#39; service was not available.&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span></div>

<div class="viewcode-block" id="PandaEnv.refresh_joints"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.refresh_joints">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_joints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Re-fetches the currently active joints.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__joints</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.gripper_width"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.gripper_width">[docs]</a>    <span class="k">def</span> <span class="nf">gripper_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the gripper width as calculated based on the Panda finger joints.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The gripper width.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">position</span><span class="p">))[</span>
                <span class="n">PANDA_JOINTS_FALLBACK</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">*</span> <span class="mi">2</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.arm_positions"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.arm_positions">[docs]</a>    <span class="k">def</span> <span class="nf">arm_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the current arm joint positions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The arm joint positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
        <span class="p">}</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.arm_velocities"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.arm_velocities">[docs]</a>    <span class="k">def</span> <span class="nf">arm_velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the current arm joint velocities.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The arm joint velocities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">velocity</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
        <span class="p">}</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.arm_efforts"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.arm_efforts">[docs]</a>    <span class="k">def</span> <span class="nf">arm_efforts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the current arm joint efforts.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The arm joint efforts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">effort</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
        <span class="p">}</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.robot_control_type"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.robot_control_type">[docs]</a>    <span class="k">def</span> <span class="nf">robot_control_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the currently set robot control type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__robot_control_type</span></div>

    <span class="nd">@robot_control_type</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">robot_control_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the robot control type while making sure the required controllers are</span>
<span class="sd">        loaded. Options are: ``trajectory``, ``position`` and ``effort``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure the controller are running.</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller_switcher</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span>
            <span class="n">control_group</span><span class="o">=</span><span class="s2">&quot;arm&quot;</span><span class="p">,</span> <span class="n">control_type</span><span class="o">=</span><span class="n">control_type</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__robot_control_type</span> <span class="o">=</span> <span class="n">control_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; since the controllers required &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for &#39;</span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">&#39; control were not loaded successfully.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.in_collision"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.in_collision">[docs]</a>    <span class="k">def</span> <span class="nf">in_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the robot is in collision.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__in_collision</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.locked_joints"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.locked_joints">[docs]</a>    <span class="k">def</span> <span class="nf">locked_joints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the currently locked joints.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__locked_joints</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.ee_link_exists"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.ee_link_exists">[docs]</a>    <span class="k">def</span> <span class="nf">ee_link_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether the end effector link exists in the robot model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the end effector link exists in the robot model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">links</span><span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.ee_pose"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.ee_pose">[docs]</a>    <span class="k">def</span> <span class="nf">ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the current end-effector pose while taking the ``ee_frame_offset``</span>
<span class="sd">        into account. If the offset is zero then it is equal to the</span>
<span class="sd">        :attr:`~PandaEnv.robot_EE_link` pose.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`geometry_msgs.msg.PoseStamped`: The end-effector pose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.ee_offset_is_zero"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.ee_offset_is_zero">[docs]</a>    <span class="k">def</span> <span class="nf">ee_offset_is_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether the end-effector frame offset is zero.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the end-effector frame offset is zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mf">1.0</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.ee_frame_offset"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.ee_frame_offset">[docs]</a>    <span class="k">def</span> <span class="nf">ee_frame_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the end-effector frame offset relative to the actual ee_link (i.e.</span>
<span class="sd">        :attr:`~PandaEnv.robot_EE_link`).</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`geometry_msgs.msg.Pose`: The ee frame offset pose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Pose</span><span class="p">(</span>
            <span class="n">position</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">normalize_quaternion</span><span class="p">(</span>
                <span class="n">Quaternion</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rx&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ry&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                    <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                    <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ee_frame_offset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rw&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaEnv.ee_frame_offset_stamped"><a class="viewcode-back" href="../../../autoapi/ros_gazebo_gym/robot_envs/panda_env/index.html#ros_gazebo_gym.robot_envs.PandaEnv.ee_frame_offset_stamped">[docs]</a>    <span class="k">def</span> <span class="nf">ee_frame_offset_stamped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the end-effector frame offset relative to the actual ee_link (i.e.</span>
<span class="sd">        :attr:`~PandaEnv.robot_EE_link`) as a stamped pose.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`geometry_msgs.msg.PoseStamped`: The ee frame offset pose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PoseStamped</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_EE_link</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
            <span class="n">pose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ee_frame_offset</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1">################################################</span>
    <span class="c1"># Overload Gazebo env virtual methods ##########</span>
    <span class="c1">################################################</span>
    <span class="c1"># NOTE: Methods needed by the gazebo environment.</span>
    <span class="k">def</span> <span class="nf">_check_all_systems_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks that all the sensors, publishers and other simulation systems are</span>
<span class="sd">        operational.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Boolean specifying whether reset was successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_sensors_ready</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Rick Staa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>